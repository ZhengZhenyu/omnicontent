name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-metadata:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check PR title
      run: |
        PR_TITLE="${{ github.event.pull_request.title }}"

        # Check if PR title follows conventional commits
        if ! echo "$PR_TITLE" | grep -qE '^(feat|fix|docs|style|refactor|perf|test|chore|build|ci)(\(.+\))?: .+'; then
          echo "âŒ PR title does not follow conventional commits format"
          echo "Expected format: type(scope): description"
          echo "Types: feat, fix, docs, style, refactor, perf, test, chore, build, ci"
          exit 1
        fi

        echo "âœ… PR title follows conventional commits format"

    - name: Check PR size
      run: |
        # Get changed lines count
        git diff --shortstat origin/${{ github.base_ref }}...HEAD > diff_stats.txt

        INSERTIONS=$(grep -oP '\d+(?= insertion)' diff_stats.txt || echo "0")
        DELETIONS=$(grep -oP '\d+(?= deletion)' diff_stats.txt || echo "0")
        TOTAL=$((INSERTIONS + DELETIONS))

        echo "ğŸ“Š Changes: +$INSERTIONS -$DELETIONS (total: $TOTAL lines)"

        # Warn if PR is too large (>1000 lines)
        if [ $TOTAL -gt 1000 ]; then
          echo "âš ï¸ This PR is quite large ($TOTAL lines). Consider splitting into smaller PRs."
        else
          echo "âœ… PR size is reasonable"
        fi

    - name: Check for Co-authored-by (should NOT be present)
      run: |
        # é¡¹ç›®è§„èŒƒï¼šä¸å…è®¸åœ¨æäº¤ä¿¡æ¯ä¸­æ·»åŠ  Co-Authored-Byï¼ˆåŒ…æ‹¬ AI ç½²åï¼‰
        COMMIT_MSG=$(git log -1 --pretty=%B)

        if echo "$COMMIT_MSG" | grep -qi "Co-Authored-By"; then
          echo "âŒ æ£€æµ‹åˆ° Co-Authored-By æ ‡è®°ï¼Œè¯·ä»æäº¤ä¿¡æ¯ä¸­ç§»é™¤è¯¥è¡Œ"
          exit 1
        fi

        echo "âœ… æäº¤ä¿¡æ¯ä¸­æ—  Co-Authored-By æ ‡è®°"

  files-changed:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v46
      with:
        files_yaml: |
          backend:
            - 'backend/**'
          frontend:
            - 'frontend/**'
          docs:
            - 'docs/**'
          config:
            - '*.yml'
            - '*.yaml'
            - '*.json'
            - 'Makefile'
            - 'docker-compose.yml'

    - name: Report changed areas
      run: |
        echo "## ğŸ“ Changed Files Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ steps.changed-files.outputs.backend_any_changed }}" == "true" ]; then
          echo "- ğŸ”§ Backend files changed" >> $GITHUB_STEP_SUMMARY
        fi

        if [ "${{ steps.changed-files.outputs.frontend_any_changed }}" == "true" ]; then
          echo "- ğŸ¨ Frontend files changed" >> $GITHUB_STEP_SUMMARY
        fi

        if [ "${{ steps.changed-files.outputs.docs_any_changed }}" == "true" ]; then
          echo "- ğŸ“ Documentation changed" >> $GITHUB_STEP_SUMMARY
        fi

        if [ "${{ steps.changed-files.outputs.config_any_changed }}" == "true" ]; then
          echo "- âš™ï¸ Configuration changed" >> $GITHUB_STEP_SUMMARY
        fi

  code-review-checklist:
    runs-on: ubuntu-latest
    # Only run when PR is opened, not on subsequent pushes
    if: github.event.action == 'opened'
    permissions:
      pull-requests: write
      issues: write

    steps:
    - name: Post review checklist
      uses: actions/github-script@v7
      with:
        script: |
          const checklist = `## PR Checklist

          - [ ] åŠŸèƒ½å®ç°æ­£ç¡®ï¼Œæ— æ˜æ˜¾ Bug
          - [ ] æµ‹è¯•é€šè¿‡ï¼ˆæ–°å¢/ä¿®æ”¹åŠŸèƒ½å·²è¡¥å……æµ‹è¯•ï¼Œè¦†ç›–ç‡ â‰¥ 80%ï¼‰
          - [ ] æ— æ•æ„Ÿä¿¡æ¯ç¡¬ç¼–ç ï¼ˆå¯†é’¥ã€å¯†ç ã€Tokenï¼‰
          - [ ] æ•°æ®åº“æœ‰å˜æ›´æ—¶è¿ç§»æ–‡ä»¶å·²ç”Ÿæˆå¹¶æµ‹è¯•
          - [ ] å¿…è¦çš„æ–‡æ¡£å·²åŒæ­¥æ›´æ–°
          `;

          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: checklist
          });
