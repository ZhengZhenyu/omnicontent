# Community Content Hub - UML设计文档

**文档版本**: v2.0
**编写日期**: 2026-02-06
**UML工具**: Mermaid（文本格式）

---

## 1. 领域模型类图 (Domain Model Class Diagram)

```mermaid
classDiagram
    class Community {
        +int id
        +string name
        +string slug
        +string description
        +string logo_url
        +json settings
        +boolean is_active
        +datetime created_at
        +datetime updated_at
        +validate_slug()
        +deactivate()
    }

    class User {
        +int id
        +string username
        +string email
        +string hashed_password
        +string full_name
        +boolean is_active
        +boolean is_superuser
        +datetime created_at
        +verify_password(password)
        +has_access_to_community(community_id)
    }

    class CommunityUser {
        +int id
        +int user_id
        +int community_id
        +string role
        +datetime joined_at
        +promote_role()
        +demote_role()
    }

    class Content {
        +int id
        +int community_id
        +int created_by_user_id
        +string title
        +text content_markdown
        +text content_html
        +string source_type
        +string source_file
        +string author
        +json tags
        +string category
        +string cover_image
        +string status
        +datetime scheduled_publish_at
        +datetime created_at
        +datetime updated_at
        +transition_status(new_status)
        +schedule_publish(date)
        +is_ready_to_publish()
    }

    class PublishRecord {
        +int id
        +int content_id
        +string channel
        +string status
        +string platform_article_id
        +string platform_url
        +datetime published_at
        +string error_message
        +datetime created_at
        +mark_success(url)
        +mark_failure(error)
    }

    class ContentAnalytics {
        +int id
        +int publish_record_id
        +int read_count
        +int like_count
        +int share_count
        +int comment_count
        +datetime collected_at
        +update_metrics()
    }

    class ChannelConfig {
        +int id
        +int community_id
        +string channel
        +json config
        +boolean enabled
        +validate_config()
        +enable()
        +disable()
    }

    class AuditLog {
        +int id
        +int user_id
        +int community_id
        +string action
        +string resource_type
        +int resource_id
        +json details
        +string ip_address
        +datetime created_at
        +query_by_user()
        +query_by_community()
    }

    %% 关系定义
    Community "1" -- "*" Content : contains
    Community "1" -- "*" ChannelConfig : has
    Community "1" -- "*" CommunityUser : has
    User "1" -- "*" CommunityUser : belongs to
    User "1" -- "*" Content : creates
    User "1" -- "*" AuditLog : performs
    Content "1" -- "*" PublishRecord : has
    PublishRecord "1" -- "0..1" ContentAnalytics : tracks
```

---

## 2. 核心服务类图 (Service Layer Class Diagram)

```mermaid
classDiagram
    class AuthService {
        -pwd_context: CryptContext
        -secret_key: string
        +login(username, password) Token
        +verify_token(token) User
        +create_access_token(user_id) string
        +hash_password(password) string
    }

    class CommunityService {
        +create_community(data) Community
        +add_member(community_id, user_id) bool
        +remove_member(community_id, user_id) bool
        +validate_access(user_id, community_id) bool
    }

    class ContentService {
        +create_content(data, community_id, user_id) Content
        +update_content(id, data) Content
        +transition_status(id, new_status) bool
        +schedule_publish(id, datetime) bool
        +get_calendar_data(community_id, date_range) list
        +get_kanban_data(community_id) dict
    }

    class ConverterService {
        +convert_docx_to_markdown(file_path) tuple
        +convert_markdown_to_html(markdown) string
        +extract_images(docx_path) list
    }

    class WeChatService {
        -app_id: string
        -app_secret: string
        -token_cache: dict
        +get_access_token() string
        +upload_image(image_path) string
        +upload_thumb_media(image_path) string
        +convert_to_wechat_html(markdown) string
        +create_draft(title, content, thumb_id) dict
    }

    class HugoService {
        -repo_path: string
        -content_dir: string
        +generate_front_matter(content) string
        +generate_post(content) string
        +save_post(content, filename) bool
    }

    class CSDNService {
        +format_for_csdn(content) dict
    }

    class ZhihuService {
        +format_for_zhihu(content) dict
    }

    class SchedulerService {
        -scheduler: APScheduler
        +start()
        +add_publish_job(content_id, datetime)
        +execute_publish_job(content_id)
    }

    class AnalyticsService {
        +get_overview(community_id) dict
        +get_dashboard_data(community_id, days) dict
        +get_by_channel(community_id) list
        +get_by_author(community_id) list
        +get_trend(community_id, days) dict
    }

    %% 服务依赖关系
    ContentService ..> ConverterService : uses
    ContentService ..> SchedulerService : uses
    SchedulerService ..> WeChatService : uses
    SchedulerService ..> HugoService : uses
```

---

## 3. 用户登录时序图 (Login Sequence Diagram)

```mermaid
sequenceDiagram
    participant User as 用户
    participant Frontend as 前端(Vue)
    participant AuthStore as Pinia Store
    participant API as FastAPI
    participant AuthService as 认证服务
    participant DB as 数据库

    User->>Frontend: 输入用户名密码
    Frontend->>Frontend: 表单验证
    Frontend->>API: POST /api/auth/login<br/>{username, password}

    API->>AuthService: login(username, password)
    AuthService->>DB: SELECT * FROM users WHERE username=?
    DB-->>AuthService: User record
    AuthService->>AuthService: verify_password(password, hashed)

    alt 密码正确
        AuthService->>AuthService: create_access_token(user_id)
        AuthService-->>API: Token
        API-->>Frontend: 200 {access_token}

        Frontend->>AuthStore: setToken(access_token)
        AuthStore->>AuthStore: localStorage.setItem('token', token)

        Frontend->>API: GET /api/auth/me<br/>Header: Authorization
        API->>DB: SELECT * FROM users WHERE id=?<br/>JOIN community_users
        DB-->>API: User + Communities
        API-->>Frontend: 200 {user, communities}

        Frontend->>AuthStore: setUser(user, communities)
        Frontend->>User: 跳转到Dashboard
    else 密码错误
        AuthService-->>API: Error
        API-->>Frontend: 401 {detail: "用户名或密码错误"}
        Frontend->>User: 显示错误提示
    end
```

---

## 4. 社区切换时序图 (Community Switching Sequence)

```mermaid
sequenceDiagram
    participant User as 用户
    participant Switcher as 社区切换器组件
    participant Store as Community Store
    participant ContentList as 内容列表组件
    participant API as FastAPI

    User->>Switcher: 选择社区(ID=5)
    Switcher->>Store: setCommunity(5)
    Store->>Store: localStorage.setItem('currentCommunityId', 5)

    Store->>Store: 触发reactivity更新

    alt 当前页面需要社区数据
        ContentList->>ContentList: watch(communityId, fetchData)
        ContentList->>API: GET /api/contents<br/>Header: X-Community-Id=5
        API->>API: get_current_community() → 5
        API->>DB: SELECT * FROM contents WHERE community_id=5
        DB-->>API: Filtered data
        API-->>ContentList: 200 {items: [...]}
        ContentList->>User: 刷新列表显示
    else 页面不依赖社区
        Store->>User: 切换完成（无需刷新）
    end
```

---

## 5. 内容发布到微信时序图 (WeChat Publishing Sequence)

```mermaid
sequenceDiagram
    participant User as 用户
    participant Frontend as 前端
    participant API as FastAPI
    participant PublishService as 发布服务
    participant WeChatService as 微信服务
    participant WeChatAPI as 微信公众号API
    participant DB as 数据库

    User->>Frontend: 点击"发布到微信"按钮
    Frontend->>API: POST /api/publish/{content_id}/wechat<br/>Header: X-Community-Id

    API->>DB: SELECT content WHERE id=? AND community_id=?
    DB-->>API: Content record

    alt 无封面图
        API-->>Frontend: 400 {detail: "缺少封面图"}
        Frontend->>User: 显示错误提示
    else 有封面图
        API->>DB: SELECT channel_config WHERE community_id=? AND channel='wechat'
        DB-->>API: {app_id, app_secret}

        API->>WeChatService: upload_thumb_media(cover_image)
        WeChatService->>WeChatService: get_access_token()
        WeChatService->>WeChatAPI: POST /cgi-bin/material/add_material
        WeChatAPI-->>WeChatService: {media_id}

        API->>WeChatService: convert_to_wechat_html(markdown)
        WeChatService-->>API: HTML with inline styles

        API->>WeChatService: create_draft(title, html, thumb_id)
        WeChatService->>WeChatAPI: POST /cgi-bin/draft/add
        WeChatAPI-->>WeChatService: {media_id, url}

        API->>DB: INSERT INTO publish_records<br/>(content_id, channel, status, url)
        DB-->>API: record created

        API->>DB: INSERT INTO audit_logs<br/>(user_id, action='publish_to_wechat')
        DB-->>API: log created

        API-->>Frontend: 200 {url: "preview_url"}
        Frontend->>User: 显示草稿预览链接
        User->>User: 在微信公众号后台确认发布
    end
```

---

## 6. 日历视图拖拽排期时序图 (Calendar Drag & Drop Sequence)

```mermaid
sequenceDiagram
    participant User as 用户
    participant Calendar as FullCalendar组件
    participant Frontend as ContentCalendar.vue
    participant API as FastAPI
    participant DB as 数据库
    participant AuditService as 审计服务

    User->>Calendar: 拖拽内容到2026-03-15
    Calendar->>Frontend: eventDrop(event)

    Frontend->>Frontend: 提取contentId和newDate
    Frontend->>API: PATCH /api/contents/{id}/schedule<br/>{scheduled_publish_at: "2026-03-15T00:00:00Z"}

    API->>DB: UPDATE contents SET scheduled_publish_at=? WHERE id=?
    DB-->>API: 1 row affected

    API->>AuditService: log_action(user, "schedule_content", details)
    AuditService->>DB: INSERT INTO audit_logs
    DB-->>AuditService: log created

    API-->>Frontend: 200 {success: true}

    alt 更新成功
        Frontend->>Calendar: event.setProp('start', newDate)
        Frontend->>User: ElMessage.success("发布时间已更新")
    else 更新失败
        Frontend->>Calendar: event.revert()
        Frontend->>User: ElMessage.error("更新失败")
    end
```

---

## 7. 看板视图拖拽改状态时序图 (Kanban Drag & Drop Sequence)

```mermaid
sequenceDiagram
    participant User as 用户
    participant Kanban as VueDraggable组件
    participant Frontend as ContentKanban.vue
    participant API as FastAPI
    participant DB as 数据库

    User->>Kanban: 将卡片从"draft"拖到"reviewing"
    Kanban->>Frontend: onChange(event)<br/>{added: {element: content}}

    Frontend->>Frontend: 获取newStatus='reviewing'
    Frontend->>API: PATCH /api/contents/{id}/status<br/>{status: "reviewing"}

    API->>API: validate_status_transition(old, new)

    alt 状态流转合法
        API->>DB: UPDATE contents SET status=?, updated_at=NOW()<br/>WHERE id=? AND community_id=?
        DB-->>API: 1 row affected

        API->>DB: INSERT INTO audit_logs<br/>(user_id, action='change_status', details)
        DB-->>API: log created

        API-->>Frontend: 200 {success: true}
        Frontend->>User: ElMessage.success("已移至审核中")
    else 状态流转不合法
        API-->>Frontend: 422 {detail: "不能从draft直接到published"}
        Frontend->>Frontend: 重新加载看板数据（回滚UI）
        Frontend->>User: ElMessage.error("状态更新失败")
    end
```

---

## 8. 数据分析仪表板加载时序图 (Analytics Dashboard Loading)

```mermaid
sequenceDiagram
    participant User as 用户
    participant Frontend as AnalyticsDashboard.vue
    participant API as FastAPI
    participant AnalyticsService as 分析服务
    participant DB as 数据库

    User->>Frontend: 访问 /analytics

    par 并行加载4个图表数据
        Frontend->>API: GET /api/analytics/by-channel?community_id=5
        API->>AnalyticsService: get_by_channel(5)
        AnalyticsService->>DB: SELECT channel, COUNT(*) FROM publish_records<br/>WHERE content_id IN (SELECT id FROM contents WHERE community_id=5)<br/>GROUP BY channel
        DB-->>AnalyticsService: [{channel: 'wechat', count: 25}, ...]
        AnalyticsService-->>API: Channel stats
        API-->>Frontend: 200 {data: [...]}

    and
        Frontend->>API: GET /api/analytics/trend?days=30&community_id=5
        API->>AnalyticsService: get_trend(5, 30)
        AnalyticsService->>DB: Complex query with date grouping
        DB-->>AnalyticsService: {dates: [...], counts: [...]}
        AnalyticsService-->>API: Trend data
        API-->>Frontend: 200 {data: {...}}

    and
        Frontend->>API: GET /api/analytics/by-author?community_id=5
        API->>AnalyticsService: get_by_author(5)
        AnalyticsService->>DB: SELECT author, COUNT(*) FROM contents<br/>WHERE community_id=5 GROUP BY author<br/>ORDER BY COUNT(*) DESC LIMIT 10
        DB-->>AnalyticsService: [{author: '张三', count: 12}, ...]
        AnalyticsService-->>API: Author stats
        API-->>Frontend: 200 {data: [...]}

    and
        Frontend->>API: GET /api/analytics/category-distribution?community_id=5
        API->>AnalyticsService: get_category_distribution(5)
        AnalyticsService->>DB: SELECT category, COUNT(*) FROM contents<br/>WHERE community_id=5 GROUP BY category
        DB-->>AnalyticsService: [{category: 'Release Note', count: 30}, ...]
        AnalyticsService-->>API: Category stats
        API-->>Frontend: 200 {data: [...]}
    end

    Frontend->>Frontend: 渲染4个ECharts图表
    Frontend->>User: 显示完整仪表板
```

---

## 9. 状态机图 - 内容状态流转 (Content Status State Machine)

```mermaid
stateDiagram-v2
    [*] --> draft: 创建内容

    draft --> reviewing: 提交审核
    draft --> published: 直接发布（跳过审核）

    reviewing --> approved: 审核通过
    reviewing --> draft: 审核退回

    approved --> published: 确认发布
    approved --> draft: 再次修改

    published --> approved: 撤回发布（允许）
    published --> [*]: 归档

    note right of draft
        草稿状态
        可编辑、可删除
    end note

    note right of reviewing
        审核中
        禁止编辑
    end note

    note right of approved
        已通过
        等待发布
    end note

    note right of published
        已发布
        仅可查看
    end note
```

**状态转换规则**:
| 当前状态 | 允许转换到 | 禁止转换到 |
|---------|-----------|-----------|
| draft | reviewing, published | approved |
| reviewing | approved, draft | published |
| approved | published, draft | reviewing |
| published | approved, archived | draft, reviewing |

---

## 10. 活动图 - WORD文件上传处理流程 (Activity Diagram)

```mermaid
flowchart TD
    Start([用户上传DOCX文件]) --> Validate{验证文件}

    Validate -->|格式错误| Error1[返回400错误:<br/>不支持的文件格式]
    Validate -->|文件过大| Error2[返回400错误:<br/>文件不能超过50MB]
    Validate -->|验证通过| Save[保存到uploads/目录]

    Save --> Extract[mammoth提取内容]
    Extract --> ConvertHTML[DOCX → HTML]
    ConvertHTML --> ExtractImages{是否有图片?}

    ExtractImages -->|有| SaveImages[保存图片到<br/>uploads/images/]
    SaveImages --> ReplaceURL[替换HTML中的图片URL]
    ReplaceURL --> ConvertMD[html2text转换为Markdown]

    ExtractImages -->|无| ConvertMD

    ConvertMD --> GenHTML[markdown库生成HTML<br/>用于预览]
    GenHTML --> CreateRecord[创建Content记录]

    CreateRecord --> SetCommunity[自动设置community_id<br/>从X-Community-Id头]
    SetCommunity --> SetCreator[自动设置created_by_user_id<br/>从JWT Token]
    SetCreator --> Commit[提交数据库事务]

    Commit --> AuditLog[记录审计日志:<br/>upload_docx]
    AuditLog --> Success[返回201 Created<br/>Content对象]

    Error1 --> End([结束])
    Error2 --> End
    Success --> End

    style Start fill:#e1f5e1
    style Success fill:#e1f5e1
    style Error1 fill:#ffe1e1
    style Error2 fill:#ffe1e1
    style End fill:#e1e1e1
```

---

## 11. 部署图 (Deployment Diagram)

```mermaid
graph TB
    subgraph "用户设备"
        Browser[Web浏览器<br/>Chrome/Firefox]
    end

    subgraph "Docker主机"
        subgraph "Frontend容器"
            Nginx[Nginx<br/>静态文件服务器]
            VueApp[Vue 3 SPA<br/>打包后的静态文件]
        end

        subgraph "Backend容器"
            Uvicorn[Uvicorn<br/>ASGI服务器]
            FastAPI[FastAPI应用<br/>Python 3.11]
        end

        subgraph "Database容器"
            Postgres[(PostgreSQL 15<br/>数据库)]
        end

        subgraph "存储卷"
            Uploads[/uploads<br/>文件存储]
            DBData[/var/lib/postgresql<br/>数据文件]
        end
    end

    subgraph "外部服务"
        WeChatAPI[微信公众号API<br/>api.weixin.qq.com]
        HugoRepo[Hugo仓库<br/>Git远程仓库]
    end

    Browser -->|HTTPS:443| Nginx
    Nginx -->|Proxy Pass<br/>:8000| Uvicorn
    FastAPI -->|SQLAlchemy| Postgres
    FastAPI -->|文件读写| Uploads
    Postgres -->|持久化| DBData
    FastAPI -->|HTTPS| WeChatAPI
    FastAPI -->|Git Push| HugoRepo

    style Browser fill:#e1f5e1
    style Nginx fill:#cce5ff
    style FastAPI fill:#ffcccc
    style Postgres fill:#fff3cd
    style Uploads fill:#f0f0f0
    style WeChatAPI fill:#e1f5e1
```

---

## 12. 包图 (Package Diagram)

```mermaid
graph TB
    subgraph "Frontend Package"
        Views[Views<br/>页面组件]
        Components[Components<br/>可复用组件]
        Stores[Stores<br/>Pinia状态]
        API[API<br/>HTTP客户端]
        Router[Router<br/>路由配置]
    end

    subgraph "Backend Package"
        APIRouters[API Routers<br/>FastAPI路由]
        Services[Services<br/>业务逻辑]
        Models[Models<br/>SQLAlchemy模型]
        Schemas[Schemas<br/>Pydantic验证]
        Core[Core<br/>认证、依赖注入]
    end

    Views --> API
    Views --> Stores
    API --> APIRouters
    APIRouters --> Services
    APIRouters --> Core
    Services --> Models
    APIRouters --> Schemas
    Schemas --> Models

    style Views fill:#cce5ff
    style Services fill:#ffcccc
    style Models fill:#fff3cd
```

---

## 13. 组件图 - 前端组件依赖 (Frontend Component Diagram)

```mermaid
graph LR
    App[App.vue<br/>根组件]

    App --> CommunitySwitcher[CommunitySwitcher<br/>社区切换器]
    App --> RouterView[router-view<br/>路由出口]

    RouterView --> Dashboard
    RouterView --> ContentList
    RouterView --> ContentEdit
    RouterView --> ContentCalendar
    RouterView --> ContentKanban
    RouterView --> AnalyticsDashboard

    ContentCalendar --> FullCalendar[FullCalendar<br/>第三方库]
    ContentCalendar --> CalendarEventDialog[CalendarEventDialog<br/>事件对话框]

    ContentKanban --> VueDraggable[VueDraggable<br/>第三方库]
    ContentKanban --> KanbanCard[KanbanCard<br/>看板卡片]

    AnalyticsDashboard --> VueECharts[VueECharts<br/>第三方库]
    AnalyticsDashboard --> ChartCard[ChartCard<br/>图表容器]

    ContentEdit --> MdEditor[MdEditor<br/>第三方库]

    style App fill:#e1f5e1
    style FullCalendar fill:#f0f0f0
    style VueDraggable fill:#f0f0f0
    style VueECharts fill:#f0f0f0
```

---

## 14. 用例图 (Use Case Diagram)

```mermaid
graph TB
    subgraph "Community Content Hub系统"
        UC1[登录系统]
        UC2[切换社区]
        UC3[创建内容]
        UC4[编辑内容]
        UC5[上传DOCX]
        UC6[日历排期]
        UC7[看板管理]
        UC8[发布到微信]
        UC9[发布到Hugo]
        UC10[查看数据分析]
        UC11[管理社区]
        UC12[管理成员]
        UC13[配置渠道]
    end

    User[社区运营专员]
    Admin[超级管理员]

    User --> UC1
    User --> UC2
    User --> UC3
    User --> UC4
    User --> UC5
    User --> UC6
    User --> UC7
    User --> UC8
    User --> UC9
    User --> UC10
    User --> UC13

    Admin --> UC1
    Admin --> UC2
    Admin --> UC11
    Admin --> UC12

    UC8 -.-> UC5: <<extend>><br/>需要封面图
    UC3 -.-> UC5: <<include>><br/>可选上传

    style User fill:#cce5ff
    style Admin fill:#ffcccc
```

---

## 15. 对象图示例 - 多社区运行时实例 (Object Diagram)

```mermaid
graph TB
    subgraph "运行时对象实例"
        C1[community:Community<br/>id=1<br/>name='Kubernetes']
        C2[community:Community<br/>id=2<br/>name='Prometheus']

        U1[user:User<br/>id=5<br/>username='zhangsan'<br/>is_superuser=false]
        U2[user:User<br/>id=1<br/>username='admin'<br/>is_superuser=true]

        CU1[communityUser:CommunityUser<br/>user_id=5<br/>community_id=1<br/>role='member']
        CU2[communityUser:CommunityUser<br/>user_id=5<br/>community_id=2<br/>role='member']

        Content1[content:Content<br/>id=123<br/>community_id=1<br/>title='K8s 1.28 Release'<br/>status='published']
        Content2[content:Content<br/>id=124<br/>community_id=2<br/>title='Prometheus 2.50'<br/>status='draft']

        PR1[publishRecord:PublishRecord<br/>id=456<br/>content_id=123<br/>channel='wechat'<br/>status='published']

        Config1[channelConfig:ChannelConfig<br/>community_id=1<br/>channel='wechat'<br/>config={app_id: 'wx123...'}]
        Config2[channelConfig:ChannelConfig<br/>community_id=2<br/>channel='wechat'<br/>config={app_id: 'wx456...'}]
    end

    C1 --> Content1
    C2 --> Content2
    C1 --> Config1
    C2 --> Config2
    U1 --> CU1
    U1 --> CU2
    CU1 --> C1
    CU2 --> C2
    Content1 --> PR1

    style C1 fill:#cce5ff
    style C2 fill:#cce5ff
    style U1 fill:#e1f5e1
    style U2 fill:#ffcccc
```

**说明**: 此图展示了系统运行时的对象实例关系，体现了多租户架构下：
- 用户zhangsan同时属于2个社区
- 每个社区有独立的内容和渠道配置
- 超级管理员admin可访问所有社区

---

**文档状态**: ✅ 已评审通过
**评审人**: 架构师、开发团队
**评审日期**: 2026-02-06

---

## 附录：Mermaid图表使用说明

本文档使用Mermaid文本格式描述UML图，可在以下工具中渲染查看：
- GitHub/GitLab（原生支持）
- VS Code插件：Markdown Preview Mermaid Support
- 在线工具：https://mermaid.live/
- Typora、Obsidian等Markdown编辑器
