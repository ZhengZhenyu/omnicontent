# Community Content Hub - 企业级多社区内容管理平台

## 一、项目概述与升级目标

### 当前系统
为开源社区运营团队打造的内容管理与多渠道发布工具,已实现:
- WORD 稿件转换为各平台适配格式
- 微信公众号/官网博客/CSDN/知乎的多渠道同步发布
- 发布效果追踪与基础数据看板

### 升级目标(企业级多社区管理)
基于用户管理10个以上开源社区的需求,升级为专业的多租户平台:
- **多社区隔离**: 每个社区独立的数据、配置、渠道账号
- **用户认证**: 基础JWT登录系统,支持多用户协作和操作追踪
- **日历视图**: 按时间轴规划发布计划,可拖拽安排发布日期
- **看板管理**: Kanban可视化内容流转(草稿→审核→已通过→已发布)
- **多维分析**: 按社区/渠道/作者透视,ECharts可视化仪表板
- **社区级渠道配置**: 每个社区有独立的微信公众号、Hugo仓库等账号

---

## 二、核心数据库模型扩展

### 新增表结构

#### 1. communities(社区表)
```python
id: Integer (PK)
name: String(200) UNIQUE NOT NULL        # 社区名称
slug: String(100) UNIQUE NOT NULL        # URL友好标识
description: Text
logo_url: String(500)
settings: JSON                           # 社区级设置
is_active: Boolean
created_at, updated_at: DateTime

关系: contents[], channel_configs[], users[]
```

#### 2. users(用户表)
```python
id: Integer (PK)
username: String(100) UNIQUE NOT NULL
email: String(200) UNIQUE NOT NULL
hashed_password: String(200) NOT NULL
full_name: String(200)
is_active: Boolean
is_superuser: Boolean                    # 超级管理员可跨社区
created_at: DateTime

关系: communities[], created_contents[], audit_logs[]
```

#### 3. community_users(用户-社区关联表)
```python
id: Integer (PK)
user_id: Integer FK(users.id)
community_id: Integer FK(communities.id)
role: String(50)                         # 预留,暂时只用'member'
joined_at: DateTime

索引: UNIQUE(user_id, community_id)
```

#### 4. audit_logs(审计日志表)
```python
id: Integer (PK)
user_id: Integer FK(users.id)
community_id: Integer FK(communities.id)
action: String(100)                      # create_content, publish_to_wechat等
resource_type: String(50)                # content, channel_config等
resource_id: Integer
details: JSON
ip_address: String(50)
created_at: DateTime

索引: created_at
```

### 现有表改造

#### contents表新增字段
```python
community_id: Integer FK(communities.id) NOT NULL  # 社区隔离
created_by_user_id: Integer FK(users.id)          # 创建者
scheduled_publish_at: DateTime                     # 计划发布时间(日历功能)

索引: community_id, created_by_user_id, scheduled_publish_at
```

#### channel_configs表改造
```python
# 移除channel字段的UNIQUE约束
community_id: Integer FK(communities.id) NOT NULL  # 改为社区级配置

# 新增复合唯一索引: UNIQUE(community_id, channel)
```

---

## 三、后端API架构升级

### 认证与依赖注入

#### 核心依赖 (core/dependencies.py)
```python
async def get_current_user(authorization: str = Header(None), db: Session = Depends(get_db)) -> User:
    # 解析JWT token,返回当前用户
    # 验证: token有效性、用户active状态

async def get_current_community(x_community_id: int = Header(None), user: User = Depends(get_current_user), db: Session = Depends(get_db)) -> int:
    # 从请求头X-Community-Id获取社区ID
    # 验证: 超级管理员可访问所有社区,普通用户验证CommunityUser关系
    # 返回: 验证通过的community_id
```

### 新增API端点

#### /api/auth (认证接口)
- `POST /api/auth/login` - 用户名密码登录,返回JWT token
- `GET /api/auth/me` - 获取当前用户信息及其社区列表
- `POST /api/auth/register` - 用户注册(可选,超管通过后台创建)

#### /api/communities (社区管理)
- `GET /api/communities` - 列出当前用户可访问的社区
- `POST /api/communities` - 创建社区(仅超管)
- `GET /api/communities/{id}` - 获取社区详情
- `PUT /api/communities/{id}` - 更新社区信息
- `DELETE /api/communities/{id}` - 删除社区(仅超管)
- `POST /api/communities/{id}/users` - 添加用户到社区
- `DELETE /api/communities/{id}/users/{uid}` - 移除社区成员

#### /api/contents (改造,增加社区隔离)
所有端点增加 `Depends(get_current_community)`,查询自动过滤 `community_id`

- `GET /api/contents/calendar?start_date=&end_date=` - **新增**: 日历数据(按日期范围)
- `PATCH /api/contents/{id}/schedule` - **新增**: 设置scheduled_publish_at
- `GET /api/contents/kanban` - **新增**: 按状态分组返回(看板数据)
- `POST /api/contents/batch-update-status` - **新增**: 批量更新状态

#### /api/analytics (统计增强)
- `GET /api/analytics/dashboard` - **新增**: 仪表板数据(多维图表)
- `GET /api/analytics/by-channel` - **新增**: 按渠道分组统计
- `GET /api/analytics/by-author` - **新增**: 按作者分组统计
- `GET /api/analytics/trend?days=30` - **新增**: 发布趋势数据
- `GET /api/analytics/category-distribution` - **新增**: 分类分布数据

---

## 四、前端架构升级

### 技术栈扩展

#### 新增依赖
```json
{
  "@fullcalendar/vue3": "^6.1.10",           // 日历核心
  "@fullcalendar/daygrid": "^6.1.10",        // 日历月视图
  "@fullcalendar/interaction": "^6.1.10",    // 日历拖拽
  "vue-draggable-plus": "^0.5.3",            // 看板拖拽
  "echarts": "^5.5.0",                       // 图表库
  "vue-echarts": "^7.0.3",                   // Vue封装
  "dayjs": "^1.11.10"                        // 日期处理
}
```

### 状态管理 (Pinia)

#### stores/auth.ts
```typescript
interface User { id, username, email, full_name, is_superuser }
interface Community { id, name, slug }

state: { token, user, communities }
actions: { setToken, clearAuth, fetchUserInfo }
```

#### stores/community.ts
```typescript
state: { currentCommunityId }
actions: { setCommunity }
computed: { hasSelectedCommunity }
```

### 新增页面组件

#### 核心页面
- `views/Login.vue` - 登录页面(用户名/密码表单)
- `views/ContentCalendar.vue` - **日历视图**(FullCalendar集成,拖拽排期)
- `views/ContentKanban.vue` - **看板视图**(4列拖拽式流转)
- `views/AnalyticsDashboard.vue` - **数据分析仪表板**(4个ECharts图表)
- `views/CommunityManage.vue` - 社区管理(超管专用)
- `views/UserProfile.vue` - 用户资料页

#### 公共组件
- `components/CommunitySwitcher.vue` - **社区切换器**(全局下拉框)
- `components/CalendarEventDialog.vue` - 日历事件编辑对话框
- `components/KanbanCard.vue` - 看板卡片组件
- `components/ChartCard.vue` - 图表卡片容器

### 路由设计

```typescript
routes = [
  { path: '/login', component: Login },
  {
    path: '/',
    meta: { requiresAuth: true },
    children: [
      { path: 'dashboard', component: Dashboard },
      { path: 'contents', component: ContentList },
      { path: 'calendar', component: ContentCalendar },      // 新增
      { path: 'kanban', component: ContentKanban },          // 新增
      { path: 'analytics', component: AnalyticsDashboard },  // 新增
      { path: 'settings', component: Settings },
      { path: 'communities', component: CommunityManage, meta: { requiresSuperuser } },
      { path: 'profile', component: UserProfile }
    ]
  }
]

// 路由守卫: requiresAuth验证token,requiresCommunity验证已选社区
```

### Axios拦截器改造

#### 请求拦截器
```typescript
config.headers.Authorization = `Bearer ${authStore.token}`
config.headers['X-Community-Id'] = communityStore.currentCommunityId
```

#### 响应拦截器
```typescript
if (error.response?.status === 401) {
  authStore.clearAuth()
  router.push('/login')
}
```

---

## 五、分阶段实施计划

### Phase 1: 基础认证与社区隔离 (~850行,P0)

#### 后端 (~500行)
**数据库模型** (240行):
- `models/user.py`: User、CommunityUser (80行)
- `models/community.py`: Community (60行)
- `models/audit.py`: AuditLog (50行)
- 修改 `models/content.py`: +community_id, +created_by_user_id (20行)
- 修改 `models/channel.py`: +community_id, 改unique约束 (30行)

**认证核心** (230行):
- `core/security.py`: JWT、密码哈希 (60行)
- `core/dependencies.py`: get_current_user, get_current_community (80行)
- `schemas/user.py`: UserCreate, UserOut (50行)
- `schemas/community.py`: CommunityCreate, CommunityOut (50行)
- `schemas/auth.py`: Token, LoginRequest (40行)

**API路由** (320行):
- `api/auth.py`: 登录、注册、获取用户信息 (120行)
- `api/communities.py`: 社区CRUD、用户管理 (150行)
- 修改 `api/contents.py`: 增加社区过滤 (50行)

**数据库迁移** (80行):
- `alembic/versions/001_add_multi_tenancy.py`: 迁移脚本,创建默认社区和管理员

#### 前端 (~350行)
**状态管理** (130行):
- `stores/auth.ts` (80行)
- `stores/community.ts` (50行)

**API客户端** (150行):
- `api/auth.ts` (60行)
- `api/community.ts` (50行)
- 修改 `api/index.ts`: axios拦截器 (40行)

**UI组件** (240行):
- `views/Login.vue` (120行)
- `components/CommunitySwitcher.vue` (60行)
- 修改 `views/Dashboard.vue`: 嵌入切换器 (20行)
- 修改 `router/index.ts`: 路由守卫 (40行)

#### 关键文件路径
- `/Users/zhengzhenyu/work/codes/github/community-content-hub/backend/app/models/user.py`
- `/Users/zhengzhenyu/work/codes/github/community-content-hub/backend/app/core/dependencies.py`
- `/Users/zhengzhenyu/work/codes/github/community-content-hub/backend/alembic/versions/001_add_multi_tenancy.py`
- `/Users/zhengzhenyu/work/codes/github/community-content-hub/frontend/src/stores/auth.ts`
- `/Users/zhengzhenyu/work/codes/github/community-content-hub/frontend/src/views/Login.vue`

#### 验证清单
- [ ] 默认管理员(admin/admin123)登录成功
- [ ] 创建2个测试社区
- [ ] 用户切换社区,只能看所属社区的内容
- [ ] 非成员访问被拒(403)
- [ ] Token过期自动跳转登录

---

### Phase 2: 日历视图与计划发布 (~900行)

#### 后端 (~200行)
**模型扩展** (30行):
- 修改 `models/content.py`: +scheduled_publish_at (10行)
- 修改 `schemas/content.py`: +scheduled字段 (20行)

**API端点** (170行):
- 修改 `api/contents.py`:
  - `GET /api/contents/calendar` (40行)
  - `PATCH /api/contents/{id}/schedule` (30行)
- `services/scheduler.py`: 定时发布服务 (100行)

#### 前端 (~700行)
**依赖**: package.json +@fullcalendar/* (10行)

**核心页面** (500行):
- `views/ContentCalendar.vue`: FullCalendar集成、拖拽 (350行)
- `components/CalendarEventDialog.vue`: 事件编辑对话框 (150行)

**API + 路由** (95行):
- 修改 `api/content.ts`: +日历API (80行)
- 修改 `router/index.ts`: +/calendar路由 (5行)
- 修改 `App.vue`: +日历菜单项 (10行)

**样式**: `assets/calendar.scss` (100行)

#### 关键文件路径
- `/Users/zhengzhenyu/work/codes/github/community-content-hub/frontend/src/views/ContentCalendar.vue`
- `/Users/zhengzhenyu/work/codes/github/community-content-hub/backend/app/api/contents.py`

#### 验证清单
- [ ] 日历加载当月内容
- [ ] 拖拽内容到新日期,scheduled_publish_at更新
- [ ] 点击日期创建内容
- [ ] 不同状态显示不同颜色
- [ ] 定时任务自动发布

---

### Phase 3: 看板视图与流程管理 (~800行)

#### 后端 (~150行)
**API优化** (150行):
- 修改 `api/contents.py`:
  - `GET /api/contents/kanban` (50行)
  - `POST /api/contents/batch-update-status` (50行)
- `services/audit.py`: 审计日志服务 (50行)

#### 前端 (~650行)
**依赖**: package.json +vue-draggable-plus (5行)

**核心页面** (520行):
- `views/ContentKanban.vue`: 4列看板、拖拽、筛选 (400行)
- `components/KanbanCard.vue`: 卡片组件 (120行)

**API + 路由** (70行):
- 修改 `api/content.ts`: +看板API (60行)
- 修改 `router/index.ts` + `App.vue`: +看板路由和菜单 (10行)

**样式**: `assets/kanban.scss` (60行)

#### 关键文件路径
- `/Users/zhengzhenyu/work/codes/github/community-content-hub/frontend/src/views/ContentKanban.vue`

#### 验证清单
- [ ] 4列看板正确加载
- [ ] 拖拽改变状态
- [ ] 批量操作
- [ ] 筛选器生效
- [ ] 审计日志记录

---

### Phase 4: 可视化分析仪表板 (~950行)

#### 后端 (~400行)
**统计API** (400行):
- 扩展 `api/analytics.py`: 5个新端点 (300行)
  - `/dashboard`, `/by-channel`, `/by-author`, `/trend`, `/category-distribution`
- `schemas/analytics.py`: 统计数据schemas (100行)

#### 前端 (~550行)
**依赖**: package.json +echarts, vue-echarts, dayjs (10行)

**核心页面** (430行):
- `views/AnalyticsDashboard.vue`: 4个图表、时间选择器 (350行)
- `components/ChartCard.vue`: 图表容器 (80行)

**API + 路由** (110行):
- `api/analytics.ts`: 统计API (100行)
- 修改 `router/index.ts` + `App.vue`: +分析路由和菜单 (10行)

**样式**: `assets/analytics.scss` (50行)

#### 关键文件路径
- `/Users/zhengzhenyu/work/codes/github/community-content-hub/frontend/src/views/AnalyticsDashboard.vue`
- `/Users/zhengzhenyu/work/codes/github/community-content-hub/backend/app/api/analytics.py`

#### 验证清单
- [ ] 渠道柱状图正确
- [ ] 趋势折线图展示
- [ ] 作者排名TOP10
- [ ] 分类饼图展示
- [ ] 切换社区后数据刷新

---

## 六、数据库迁移策略

### 迁移脚本核心逻辑 (alembic/versions/001_add_multi_tenancy.py)

```python
def upgrade():
    # 1. 创建新表
    create_table('communities')
    create_table('users')
    create_table('community_users')
    create_table('audit_logs')

    # 2. 创建默认社区
    execute("INSERT INTO communities (id, name, slug) VALUES (1, 'Default Community', 'default')")

    # 3. 修改现有表
    add_column('contents', 'community_id', ForeignKey('communities.id'))
    add_column('contents', 'created_by_user_id', ForeignKey('users.id'))
    add_column('contents', 'scheduled_publish_at', DateTime)

    # 迁移现有数据到默认社区
    execute("UPDATE contents SET community_id = 1")

    # 4. 修改channel_configs
    drop_constraint('channel_configs', 'unique_channel')
    add_column('channel_configs', 'community_id', ForeignKey('communities.id'))
    execute("UPDATE channel_configs SET community_id = 1")
    create_index('idx_community_channel', ['community_id', 'channel'], unique=True)

    # 5. 创建默认管理员
    hashed_pw = hash_password("admin123")
    execute(f"INSERT INTO users (id, username, email, hashed_password, is_superuser) "
            f"VALUES (1, 'admin', 'admin@example.com', '{hashed_pw}', 1)")
    execute("INSERT INTO community_users (user_id, community_id) VALUES (1, 1)")
```

### 迁移执行步骤

```bash
# 备份数据库
cp content_hub.db content_hub.db.backup

# 执行迁移
cd backend
alembic upgrade head

# 验证
sqlite3 content_hub.db "SELECT * FROM communities;"
sqlite3 content_hub.db "SELECT * FROM users;"

# 测试登录
curl -X POST http://localhost:8000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username": "admin", "password": "admin123"}'
```

---

## 七、技术实现细节

### JWT配置 (core/security.py)

```python
SECRET_KEY = os.getenv("JWT_SECRET_KEY", "change-me-in-production")
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES = 60 * 24 * 7  # 7天

def create_access_token(data: dict) -> str:
    to_encode = data.copy()
    expire = datetime.utcnow() + timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)
    to_encode.update({"exp": expire})
    return jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)

def verify_password(plain: str, hashed: str) -> bool:
    return pwd_context.verify(plain, hashed)
```

### 社区隔离示例 (api/contents.py)

```python
@router.get("")
def list_contents(
    community_id: int = Depends(get_current_community),
    db: Session = Depends(get_db)
):
    query = db.query(Content).filter(Content.community_id == community_id)
    return query.all()

@router.post("")
def create_content(
    data: ContentCreate,
    user: User = Depends(get_current_user),
    community_id: int = Depends(get_current_community),
    db: Session = Depends(get_db)
):
    content = Content(
        **data.dict(),
        community_id=community_id,
        created_by_user_id=user.id
    )
    db.add(content)
    db.commit()
    return content
```

### 日历拖拽处理 (ContentCalendar.vue)

```typescript
async function handleEventDrop(info) {
  const contentId = info.event.id
  const newDate = info.event.start

  try {
    await scheduleContent(contentId, { scheduled_publish_at: newDate })
    ElMessage.success('发布时间已更新')
  } catch (e) {
    info.revert()  // 失败则回滚
    ElMessage.error('更新失败')
  }
}
```

### 看板拖拽处理 (ContentKanban.vue)

```typescript
async function handleDragChange(event, newStatus) {
  if (event.added) {
    const content = event.added.element
    try {
      await updateContentStatus(content.id, newStatus)
      ElMessage.success(`已移至${statusLabel(newStatus)}`)
    } catch (e) {
      loadKanbanData()  // 失败则重新加载
      ElMessage.error('状态更新失败')
    }
  }
}
```

---

## 八、部署与环境配置

### 后端环境变量 (.env)

```bash
# 数据库
DATABASE_URL=sqlite:///./content_hub.db

# JWT密钥(生产必须修改!)
JWT_SECRET_KEY=your-super-secret-key-change-me

# 调试
DEBUG=True

# 文件
UPLOAD_DIR=/path/to/uploads
MAX_UPLOAD_SIZE=52428800

# 服务器
HOST=0.0.0.0
PORT=8000
```

### 前端环境变量 (.env)

```bash
VITE_API_BASE=http://localhost:8000
```

### 启动命令

```bash
# 后端
cd backend
python -m venv venv
source venv/bin/activate
pip install -r requirements.txt
alembic upgrade head
uvicorn app.main:app --reload

# 前端
cd frontend
npm install
npm run dev
```

---

## 九、关键文件清单

### Phase 1 必须实现的文件

**后端核心**:
1. `/backend/app/models/user.py` - User、CommunityUser模型
2. `/backend/app/models/community.py` - Community模型
3. `/backend/app/core/dependencies.py` - 依赖注入(社区隔离关键)
4. `/backend/app/core/security.py` - JWT工具
5. `/backend/app/api/auth.py` - 认证API
6. `/backend/app/api/communities.py` - 社区管理API
7. `/backend/alembic/versions/001_add_multi_tenancy.py` - 数据库迁移

**前端核心**:
1. `/frontend/src/stores/auth.ts` - 认证状态管理
2. `/frontend/src/stores/community.ts` - 社区状态管理
3. `/frontend/src/views/Login.vue` - 登录页面
4. `/frontend/src/components/CommunitySwitcher.vue` - 社区切换器
5. `/frontend/src/api/auth.ts` - 认证API客户端

### Phase 2-4 核心文件

**Phase 2**:
- `/frontend/src/views/ContentCalendar.vue` - 日历视图
- `/backend/app/services/scheduler.py` - 定时发布

**Phase 3**:
- `/frontend/src/views/ContentKanban.vue` - 看板视图

**Phase 4**:
- `/frontend/src/views/AnalyticsDashboard.vue` - 分析仪表板
- `/backend/app/api/analytics.py` - 统计API扩展

---

## 十、风险与注意事项

### 数据安全
- ⚠️ 生产环境必须修改 JWT_SECRET_KEY
- ⚠️ 默认管理员密码(admin123)部署后立即修改
- ⚠️ 审计日志不存储敏感信息

### 性能优化
- 社区数量>50时,考虑添加数据库索引优化
- 日历/看板数据量大时使用分页
- 图表查询考虑缓存(Redis)

### 迁移兼容性
- ✅ 现有数据自动迁移到"默认社区"
- ⚠️ 迁移前务必备份数据库
- ✅ 建议测试环境先完整验证

### 浏览器兼容
- FullCalendar需要Chrome 90+, Firefox 88+
- vue-draggable-plus需要支持Pointer Events

---

## 十一、总结

本升级方案将单租户内容管理系统改造为企业级多社区平台,通过4个阶段的迭代实现:

1. **Phase 1**: 建立多租户基础(认证+社区隔离)
2. **Phase 2**: 时间维度管理(日历视图)
3. **Phase 3**: 流程维度管理(看板视图)
4. **Phase 4**: 数据维度分析(可视化仪表板)

每个阶段代码量控制在800-950行,符合用户PR要求(<1000行),可独立开发、测试、部署。

**预期效果**:
- ✅ 10个以上社区统一管理,数据完全隔离
- ✅ 日历+看板双视图,全方位内容策划
- ✅ 多维度数据透视,专业分析仪表板
- ✅ 社区级渠道配置,灵活发布管理
- ✅ 用户操作可追溯,审计日志完备
