# openGecko 综合重构计划

## 背景

基于对整个代码库的全面探索，从三个方面对 openGecko 进行重构：
1. **UX 优化**：从工程师思维转向以"社区"为中心的用户体验，含全面仪表盘沙盘
2. **开发者规范**：完善 CLAUDE.md，覆盖安全、编码规范、测试、Git 工作流等
3. **生产部署就绪**：日志、安全加固、健康检查、环境管理等

## 已发现的关键问题

- `CommunityOverview.vue:207-275`：N+1 查询问题，每个社区发 3-4 个请求
- `backend/app/api/analytics.py` 的 `get_overview` 缺少 `community_id` 过滤（多租户安全漏洞）
- `main.py` CORS 配置为 `allow_origins=["*"]`
- 4 处 `print()` 语句未使用结构化日志
- 健康检查端点过于简单，仅返回 `{"status": "ok"}`
- 导航栏"仪表板"排在末尾，设置散落在多个页面

---

## 第一阶段：基础设施与开发者规范

### 1.1 增强 CLAUDE.md

**文件：** `CLAUDE.md`

扩展现有内容，新增以下章节：
- **安全编码标准**：输入验证(Pydantic)、SQL注入防护(ORM only)、XSS防护、文件上传白名单、敏感数据加密(Fernet)、OWASP检查清单
- **后端编码规范**：命名(snake_case文件/PascalCase类)、目录职责(api仅路由/services放逻辑)、多租户规范(必须过滤community_id)、错误处理(HTTPException/禁止裸except)
- **前端编码规范**：Composition API(`<script setup lang="ts">`)、Props/Emits类型化、Pinia状态管理模式、API调用封装在api/目录、Element Plus组件使用规范
- **测试要求**：后端80%覆盖率、测试文件命名`test_{module}_api.py`、mock外部服务
- **Git工作流**：分支策略(main/develop/feature/fix)、commit前缀(feat:/fix:/docs:)、不添加Co-Authored-By
- **API设计标准**：RESTful约定、分页格式(`{items, total, page, page_size}`)、错误响应格式
- **数据库迁移指南**：autogenerate后审查、支持upgrade/downgrade、SQLite/PG兼容性

### 1.2 结构化日志

**新建：** `backend/app/core/logging.py`
- `setup_logging()` 函数，支持 text/json 两种格式
- `get_logger(name)` 工厂函数

**修改：**
- `backend/app/config.py` — 新增 `LOG_LEVEL`, `LOG_FORMAT`, `ENVIRONMENT` 配置
- `backend/app/main.py` — 调用 `setup_logging()`
- `backend/app/database.py` — 替换 `print()` 为 `logger.info()`
- `backend/app/services/wechat.py` — 替换 2 处 `print()`
- `backend/app/api/auth.py` — 替换 1 处 `print()`

### 1.3 环境变量管理增强

**修改：** `backend/app/config.py`
- 新增 `ENVIRONMENT` 字段 (development/staging/production)
- 添加 Pydantic validator：生产环境禁止默认 JWT_SECRET_KEY，警告 SQLite
- 新增 `CORS_ORIGINS`, `RATE_LIMIT_LOGIN`, `RATE_LIMIT_DEFAULT` 配置

**修改：** `backend/.env.example` — 补充所有新增环境变量

---

## 第二阶段：后端 API 增强与安全加固

### 2.1 社区沙盘聚合 API

**新建：** `backend/app/api/community_dashboard.py`

端点：`GET /api/communities/{community_id}/dashboard`

返回聚合数据：
- `content_metrics`：总数、按状态分布、按工作状态分布、近7天/30天新增
- `governance_metrics`：委员会数、活跃委员会、成员总数、即将会议、近期完成会议
- `member_metrics`：总数、admin/user分布
- `channel_metrics`：渠道总数、已启用数、各渠道发布计数
- `content_publish_trend`：最近6个月发布趋势（labels + values）
- `recent_contents`：最新5条内容摘要
- `upcoming_meetings`：即将召开的5场会议

**新建：** `backend/app/schemas/community_dashboard.py` — 对应 Pydantic schema

**修改：** `backend/app/main.py` — 注册新路由

### 2.2 社区总览聚合 API（解决 N+1）

**修改：** `backend/app/api/communities.py`

新增端点：`GET /api/communities/overview/stats`（超级管理员专用）
- 使用 JOIN + GROUP BY 一次性查询所有社区的统计数据
- 替代前端逐个社区发 N*4 个请求的模式

### 2.3 修复 analytics.py 多租户漏洞

**修改：** `backend/app/api/analytics.py`
- `get_overview` 端点添加 `community_id = Depends(get_current_community)` 过滤

### 2.4 增强健康检查

**修改：** `backend/app/main.py`
- 保留简单 `/api/health`
- 新增 `/api/health/detailed`：检查数据库连接、上传目录、SMTP配置状态

### 2.5 安全加固

**修改：** `backend/app/main.py`
- CORS：根据 `CORS_ORIGINS` 配置收紧（生产环境指定具体域名）
- 速率限制：使用 slowapi，登录端点 10/min，默认 120/min
- 请求计时中间件：记录每个请求的处理时间

**修改：** `backend/requirements.txt` — 添加 `slowapi`, `gunicorn`, `python-json-logger`

### 2.6 后端测试

- 为 `community_dashboard` API 新增测试文件 `tests/test_community_dashboard_api.py`
- 验证 analytics 多租户修复

---

## 第三阶段：社区沙盘前端（核心 UX 改造）

### 3.1 新建社区沙盘页面

**新建文件：**
- `frontend/src/views/CommunitySandbox.vue` — 主页面
- `frontend/src/api/communityDashboard.ts` — API 调用模块
- `frontend/src/components/dashboard/ContentMetricsCard.vue` — 内容指标卡片
- `frontend/src/components/dashboard/GovernanceMetricsCard.vue` — 治理指标卡片
- `frontend/src/components/dashboard/MemberMetricsCard.vue` — 成员指标卡片
- `frontend/src/components/dashboard/ChannelMetricsCard.vue` — 渠道指标卡片
- `frontend/src/components/dashboard/TrendChart.vue` — 趋势图组件（ECharts）
- `frontend/src/components/dashboard/QuickActions.vue` — 快捷操作组件

**页面布局：**
```
┌──────────────────────────────────────────────────────┐
│  社区名称 + 描述                     [快捷操作按钮组]  │
├──────────────────────────────────────────────────────┤
│ [内容总数] [已发布] [待审核] [草稿]   — 指标卡片行1   │
├──────────────────────────────────────────────────────┤
│ [委员会数] [成员数] [即将会议] [活跃渠道] — 卡片行2   │
├────────────────────────┬─────────────────────────────┤
│  内容发布趋势(折线图)    │  渠道发布统计(条形图)       │
├────────────────────────┼─────────────────────────────┤
│  最近内容列表(5条)       │  即将召开的会议(5场)        │
└────────────────────────┴─────────────────────────────┘
```

**新增依赖：** `echarts`, `vue-echarts` 添加到 `frontend/package.json`

### 3.2 改造路由和导航

**修改：** `frontend/src/router/index.ts`
- 新增 `/sandbox` 路由指向 `CommunitySandbox.vue`

**修改：** `frontend/src/App.vue`
- 导航栏重组：`社区沙盘(新) > 我的工作 > 内容管理 > 发布管理 > 社区治理 > [superuser菜单]`
- 删除末尾的"仪表板"菜单项（被社区沙盘取代）
- 社区沙盘设为选中社区后的默认页

### 3.3 改进 CommunitySwitcher

**修改：** `frontend/src/components/CommunitySwitcher.vue`
- 切换社区后：若在全局页面则跳转到 `/sandbox`，若在社区级页面则留在当前页刷新数据

### 3.4 优化 CommunityOverview.vue

**修改：** `frontend/src/views/CommunityOverview.vue`
- 用新的聚合 API (`/communities/overview/stats`) 替代 N+1 请求模式

---

## 第四阶段：配置向导和 UX 优化

### 4.1 社区初始化向导

**新建：** `frontend/src/components/wizard/CommunitySetupWizard.vue`

使用 Element Plus `el-steps`，5步引导：
1. 基本信息（名称、标识、描述、URL、Logo）
2. 渠道配置（选择并配置要启用的渠道）
3. 邮件设置（SMTP，含自动检测常见提供商如QQ/Gmail/163/Outlook）
4. 邀请成员（批量邀请用户加入社区）
5. 完成 → 跳转到社区沙盘

**触发时机：** 创建社区成功后弹出；或社区沙盘检测到新社区(0内容/0渠道)时提示

### 4.2 渠道配置向导

**新建：** `frontend/src/components/wizard/ChannelSetupWizard.vue`

每个渠道提供分步引导式配置，含文字说明和输入验证

### 4.3 统一社区设置中心

**新建：** `frontend/src/views/CommunitySettings.vue`

使用 `el-tabs` 组织当前散落在多处的设置：
- Tab 1: 基本信息（原在 CommunityManage 对话框）
- Tab 2: 渠道配置（原独立 Settings.vue）
- Tab 3: 邮件设置（原在 CommunityManage 对话框）
- Tab 4: 成员管理（原在 CommunityManage 对话框）

**修改：** `frontend/src/router/index.ts` — 添加 `/community-settings` 路由

### 4.4 SMTP 自动检测

在邮件设置中，根据 `from_email` 的域名自动推荐 SMTP 配置：
- `qq.com` → `smtp.qq.com:465`
- `gmail.com` → `smtp.gmail.com:587`
- `163.com` → `smtp.163.com:465`
- `outlook.com` → `smtp.office365.com:587`

---

## 第五阶段：生产部署加固

### 5.1 Docker Compose 增强

**修改：** `docker-compose.yml`
- 添加 healthcheck 配置
- 添加 `restart: unless-stopped`
- 添加资源限制
- backend 依赖健康检查通过后启动 frontend

### 5.2 Nginx 安全加固

**修改：** `frontend/nginx.conf`
- 安全头：X-Frame-Options, X-Content-Type-Options, X-XSS-Protection, CSP
- Gzip 压缩
- 代理超时配置
- 上传文件缓存策略

### 5.3 Backend Dockerfile 优化

**修改：** `backend/Dockerfile`
- 使用非 root 用户运行
- 生产环境使用 gunicorn + uvicorn workers
- 系统依赖优化

### 5.4 多环境配置模板

**新建：**
- `backend/.env.production.example`
- `backend/.env.staging.example`

### 5.5 监控集成点（预留）

**修改：** `backend/app/config.py` — 添加可选的 `SENTRY_DSN`, `PROMETHEUS_ENABLED`
**修改：** `backend/app/main.py` — 条件初始化 Sentry；请求计时中间件

---

## 阶段依赖关系

```
第一阶段 (规范 + 日志 + 环境变量)
    ↓
第二阶段 (后端API + 安全)  ← 第一阶段的日志/配置基础
    ↓
第三阶段 (社区沙盘前端)    ← 强依赖第二阶段的聚合API
    ↓
第四阶段 (配置向导)        ← 依赖第三阶段的沙盘入口衔接
    ↓
第五阶段 (生产部署)        ← 相对独立，可与第三/四阶段并行
```

## 文件变更汇总

**新建（~17个）：** 1个日志模块 + 2个后端API/Schema + 2个环境模板 + 1个沙盘页面 + 1个API模块 + 6个dashboard组件 + 2个向导组件 + 1个社区设置页 + 1个测试文件

**修改（~18个）：** CLAUDE.md, config.py, main.py, database.py, analytics.py, communities.py, auth.py, wechat.py, requirements.txt, Dockerfile, .env.example, router/index.ts, App.vue, CommunityOverview.vue, CommunitySwitcher.vue, Settings.vue, nginx.conf, docker-compose.yml, package.json

## 验证方案

每个阶段完成后：
1. `cd backend && pytest -v --cov=app` — 后端测试通过且覆盖率 ≥ 80%
2. `cd frontend && npm run build` — 前端构建 + TypeScript 类型检查通过
3. `make dev` — 本地启动验证功能正常
4. 第三阶段完成后：手动验证社区沙盘页面数据加载和图表渲染
5. 第五阶段完成后：`docker compose up -d` 验证容器化部署正常
