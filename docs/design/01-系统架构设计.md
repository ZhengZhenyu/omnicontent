# Community Content Hub - 系统架构设计文档

**文档版本**: v2.0
**编写日期**: 2026-02-06
**架构风格**: 前后端分离 + 多租户SaaS架构

---

## 1. 架构概览

### 1.1 总体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         客户端层 (Client Layer)                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│   │  Web Browser │  │   Desktop   │  │   Mobile    │            │
│   │  (Vue 3 SPA) │  │   (Electron)│  │ (未来规划)  │            │
│   └──────┬──────┘  └──────┬──────┘  └──────┬──────┘            │
│          │                 │                 │                    │
│          └─────────────────┴─────────────────┘                    │
│                            │                                      │
│                            │ HTTPS/REST API                       │
│                            │                                      │
└────────────────────────────┼──────────────────────────────────────┘
                             │
┌────────────────────────────┼──────────────────────────────────────┐
│                         应用层 (Application Layer)                 │
├────────────────────────────┴──────────────────────────────────────┤
│                                                                     │
│   ┌─────────────────────────────────────────────────────────┐    │
│   │              FastAPI Application Server                  │    │
│   ├─────────────────────────────────────────────────────────┤    │
│   │                                                           │    │
│   │  ┌────────────┐  ┌────────────┐  ┌────────────┐        │    │
│   │  │ Auth API   │  │Content API │  │Publish API │        │    │
│   │  └────────────┘  └────────────┘  └────────────┘        │    │
│   │                                                           │    │
│   │  ┌────────────┐  ┌────────────┐  ┌────────────┐        │    │
│   │  │Community   │  │Analytics   │  │ User API   │        │    │
│   │  │   API      │  │    API     │  │            │        │    │
│   │  └────────────┘  └────────────┘  └────────────┘        │    │
│   │                                                           │    │
│   ├─────────────────────────────────────────────────────────┤    │
│   │                   Middleware Layer                        │    │
│   ├─────────────────────────────────────────────────────────┤    │
│   │  • JWT Authentication    • CORS Policy                  │    │
│   │  • Community Isolation   • Error Handler                │    │
│   │  • Audit Logging        • Request ID Tracking           │    │
│   └─────────────────────────────────────────────────────────┘    │
│                                                                     │
└─────────────────────────────────┬───────────────────────────────┘
                                  │
┌─────────────────────────────────┼───────────────────────────────┐
│                         业务逻辑层 (Business Logic Layer)          │
├─────────────────────────────────┴───────────────────────────────┤
│                                                                    │
│   ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│   │   Converter  │  │    WeChat    │  │     Hugo     │         │
│   │   Service    │  │   Service    │  │   Service    │         │
│   └──────────────┘  └──────────────┘  └──────────────┘         │
│                                                                    │
│   ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│   │     CSDN     │  │    Zhihu     │  │  Scheduler   │         │
│   │   Service    │  │   Service    │  │   Service    │         │
│   └──────────────┘  └──────────────┘  └──────────────┘         │
│                                                                    │
└─────────────────────────────────┬───────────────────────────────┘
                                  │
┌─────────────────────────────────┼───────────────────────────────┐
│                          数据层 (Data Layer)                       │
├─────────────────────────────────┴───────────────────────────────┤
│                                                                    │
│   ┌──────────────────────────────────────────────────────────┐  │
│   │              SQLAlchemy ORM + Alembic Migration           │  │
│   └──────────────────────────────────────────────────────────┘  │
│                                                                    │
│   ┌──────────────────────────────────────────────────────────┐  │
│   │                  SQLite / PostgreSQL                       │  │
│   ├──────────────────────────────────────────────────────────┤  │
│   │  ┌───────────┐  ┌───────────┐  ┌───────────┐             │  │
│   │  │communities│  │   users   │  │  contents │             │  │
│   │  └───────────┘  └───────────┘  └───────────┘             │  │
│   │                                                            │  │
│   │  ┌───────────┐  ┌───────────┐  ┌───────────┐             │  │
│   │  │  publish  │  │  channel  │  │   audit   │             │  │
│   │  │  records  │  │  configs  │  │   logs    │             │  │
│   │  └───────────┘  └───────────┘  └───────────┘             │  │
│   └──────────────────────────────────────────────────────────┘  │
│                                                                    │
└────────────────────────────────────────────────────────────────┘
                                  │
┌─────────────────────────────────┼───────────────────────────────┐
│                        外部服务层 (External Services)              │
├─────────────────────────────────┴───────────────────────────────┤
│                                                                    │
│   ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│   │    WeChat    │  │     Hugo     │  │     CSDN     │         │
│   │ Official API │  │  Git Repo    │  │   Website    │         │
│   └──────────────┘  └──────────────┘  └──────────────┘         │
│                                                                    │
│   ┌──────────────┐  ┌──────────────┐                            │
│   │    Zhihu     │  │    Email     │                            │
│   │   Website    │  │   Service    │                            │
│   └──────────────┘  └──────────────┘                            │
│                                                                    │
└────────────────────────────────────────────────────────────────┘
                                  │
┌─────────────────────────────────┼───────────────────────────────┐
│                        文件存储层 (Storage Layer)                  │
├─────────────────────────────────┴───────────────────────────────┤
│                                                                    │
│   ┌──────────────────────────────────────────────────────────┐  │
│   │                  Local File System                         │  │
│   ├──────────────────────────────────────────────────────────┤  │
│   │  • /uploads/files/    - 上传的DOCX文件                    │  │
│   │  • /uploads/images/   - 从DOCX提取的图片                  │  │
│   │  • /uploads/covers/   - 封面图                            │  │
│   └──────────────────────────────────────────────────────────┘  │
│                                                                    │
└────────────────────────────────────────────────────────────────┘
```

### 1.2 技术栈选型

| 层级 | 技术选型 | 版本 | 选型理由 |
|------|---------|------|---------|
| **前端框架** | Vue.js | 3.3+ | 渐进式框架，生态成熟，开发效率高 |
| **状态管理** | Pinia | 2.3+ | Vue官方推荐，TypeScript友好 |
| **UI组件库** | Element Plus | 2.9+ | 企业级组件库，文档完善 |
| **日历组件** | FullCalendar | 6.1+ | 功能强大，支持拖拽 |
| **看板拖拽** | vue-draggable-plus | 0.5+ | Vue 3兼容，性能优秀 |
| **图表库** | ECharts | 5.5+ | 功能全面，社区活跃 |
| **Markdown编辑器** | md-editor-v3 | 5.1+ | Vue 3原生支持，预览实时 |
| **HTTP客户端** | Axios | 1.7+ | 拦截器灵活，错误处理完善 |
| **构建工具** | Vite | 6.0+ | 快速冷启动，HMR高效 |
| **后端框架** | FastAPI | 0.100+ | 异步高性能，自动生成API文档 |
| **ORM** | SQLAlchemy | 2.0+ | Python最成熟的ORM |
| **数据库** | SQLite / PostgreSQL | 3.35+ / 15+ | 轻量级部署 / 生产级扩展 |
| **迁移工具** | Alembic | 1.13+ | SQLAlchemy官方推荐 |
| **身份认证** | PyJWT | 2.8+ | JWT标准实现 |
| **密码哈希** | Passlib + bcrypt | 1.7+ | 安全性高 |
| **DOCX处理** | python-mammoth | 1.6+ | DOCX→HTML转换质量高 |
| **Markdown渲染** | python-markdown | 3.5+ | 扩展性强 |
| **任务调度** | APScheduler | 3.10+ | 定时发布功能 |

---

## 2. 多租户架构设计

### 2.1 多租户模式

采用**共享数据库、共享Schema、数据隔离**模式：

```
┌────────────────────────────────────────────────────────────┐
│                      单一应用实例                            │
├────────────────────────────────────────────────────────────┤
│                                                              │
│   ┌───────────┐   ┌───────────┐   ┌───────────┐           │
│   │ Community │   │ Community │   │ Community │           │
│   │     A     │   │     B     │   │     C     │           │
│   └─────┬─────┘   └─────┬─────┘   └─────┬─────┘           │
│         │               │               │                   │
│         └───────────────┼───────────────┘                   │
│                         │                                    │
│                  ┌──────▼──────┐                            │
│                  │  ORM Layer  │                            │
│                  │ (Filtering) │                            │
│                  └──────┬──────┘                            │
│                         │                                    │
│                  ┌──────▼──────────────────────┐            │
│                  │   Shared Database           │            │
│                  ├─────────────────────────────┤            │
│                  │ ┌─────────────────────────┐ │            │
│                  │ │ contents                │ │            │
│                  │ │ ├─ id                   │ │            │
│                  │ │ ├─ community_id (FK)    │ │<-- 隔离字段│
│                  │ │ ├─ title                │ │            │
│                  │ │ └─ ...                  │ │            │
│                  │ └─────────────────────────┘ │            │
│                  │                             │            │
│                  │ ┌─────────────────────────┐ │            │
│                  │ │ channel_configs         │ │            │
│                  │ │ ├─ id                   │ │            │
│                  │ │ ├─ community_id (FK)    │ │<-- 隔离字段│
│                  │ │ ├─ channel              │ │            │
│                  │ │ └─ ...                  │ │            │
│                  │ └─────────────────────────┘ │            │
│                  └─────────────────────────────┘            │
│                                                              │
└────────────────────────────────────────────────────────────┘
```

**优势**:
- ✅ 部署简单，单一实例
- ✅ 成本低，资源共享
- ✅ 维护方便，统一升级

**隔离机制**:
- 所有查询自动添加 `WHERE community_id = ?`
- 中间件层统一注入community_id
- 外键约束保证数据一致性

### 2.2 租户识别流程

```
┌─────────┐        ┌──────────────┐        ┌─────────────┐
│ Client  │        │  API Server  │        │  Database   │
└────┬────┘        └───────┬──────┘        └──────┬──────┘
     │                     │                       │
     │  1. HTTP Request    │                       │
     │  Headers:           │                       │
     │  Authorization      │                       │
     │  X-Community-Id     │                       │
     ├────────────────────>│                       │
     │                     │                       │
     │                     │  2. Verify JWT        │
     │                     │  get_current_user()   │
     │                     │───────┐               │
     │                     │       │               │
     │                     │<──────┘               │
     │                     │  User Object          │
     │                     │                       │
     │                     │  3. Validate Community│
     │                     │  get_current_community│
     │                     │───────┐               │
     │                     │       │ Check         │
     │                     │       │ membership    │
     │                     │<──────┘               │
     │                     │  community_id         │
     │                     │                       │
     │                     │  4. Query with Filter │
     │                     │  WHERE community_id=? │
     │                     ├──────────────────────>│
     │                     │                       │
     │                     │<──────────────────────┤
     │                     │  Filtered Data        │
     │  5. JSON Response   │                       │
     │<────────────────────┤                       │
     │                     │                       │
```

### 2.3 依赖注入实现

```python
# core/dependencies.py

async def get_current_user(
    authorization: str = Header(None),
    db: Session = Depends(get_db)
) -> User:
    """解析JWT Token，返回当前用户"""
    if not authorization or not authorization.startswith("Bearer "):
        raise HTTPException(401, "未认证")

    token = authorization.replace("Bearer ", "")
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        user_id = payload.get("sub")
    except JWTError:
        raise HTTPException(401, "Token无效")

    user = db.query(User).filter(User.id == user_id, User.is_active == True).first()
    if not user:
        raise HTTPException(401, "用户不存在")

    return user


async def get_current_community(
    x_community_id: int = Header(None),
    user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
) -> int:
    """验证用户对社区的访问权限，返回community_id"""
    if not x_community_id:
        raise HTTPException(400, "缺少 X-Community-Id 请求头")

    # 超级管理员可访问所有社区
    if user.is_superuser:
        return x_community_id

    # 普通用户验证成员关系
    membership = db.query(CommunityUser).filter(
        CommunityUser.user_id == user.id,
        CommunityUser.community_id == x_community_id
    ).first()

    if not membership:
        raise HTTPException(403, "无权访问该社区")

    return x_community_id
```

**使用示例**:
```python
@router.get("/contents")
def list_contents(
    community_id: int = Depends(get_current_community),
    db: Session = Depends(get_db)
):
    # community_id已验证，直接使用
    return db.query(Content).filter(Content.community_id == community_id).all()
```

---

## 3. 数据库设计

### 3.1 ER图（Entity Relationship Diagram）

```
┌─────────────────────┐
│     communities     │
├─────────────────────┤
│ PK  id              │
│     name (UNIQUE)   │
│     slug (UNIQUE)   │
│     description     │
│     logo_url        │
│     settings (JSON) │
│     is_active       │
│     created_at      │
│     updated_at      │
└──────────┬──────────┘
           │ 1
           │
           │ N
┌──────────▼──────────┐        ┌─────────────────────┐
│ community_users     │   N:M  │       users         │
├─────────────────────┤◄──────►├─────────────────────┤
│ PK  id              │        │ PK  id              │
│ FK  user_id         │        │     username (UQ)   │
│ FK  community_id    │        │     email (UQ)      │
│     role            │        │     hashed_password │
│     joined_at       │        │     full_name       │
│ UQ(user_id,         │        │     is_active       │
│    community_id)    │        │     is_superuser    │
└─────────────────────┘        │     created_at      │
                               └──────────┬──────────┘
                                          │ 1
           ┌──────────────────────────────┤
           │ 1                            │ 1
           │                              │
┌──────────▼──────────┐        ┌─────────▼─────────┐
│      contents       │        │    audit_logs     │
├─────────────────────┤        ├───────────────────┤
│ PK  id              │        │ PK  id            │
│ FK  community_id    │        │ FK  user_id       │
│ FK  created_by      │        │ FK  community_id  │
│     title           │        │     action        │
│     content_md      │        │     resource_type │
│     content_html    │        │     resource_id   │
│     source_type     │        │     details (JSON)│
│     author          │        │     ip_address    │
│     tags (JSON)     │        │     created_at    │
│     category        │        │ IDX created_at    │
│     cover_image     │        └───────────────────┘
│     status          │
│     scheduled_at    │
│     created_at      │
│     updated_at      │
│ IDX community_id    │
│ IDX created_by      │
│ IDX scheduled_at    │
└──────────┬──────────┘
           │ 1
           │
           │ N
┌──────────▼──────────┐        ┌─────────────────────┐
│   publish_records   │   1:N  │  content_analytics  │
├─────────────────────┤◄───────├─────────────────────┤
│ PK  id              │        │ PK  id              │
│ FK  content_id      │        │ FK  publish_rec_id  │
│     channel         │        │     read_count      │
│     status          │        │     like_count      │
│     platform_id     │        │     share_count     │
│     platform_url    │        │     comment_count   │
│     published_at    │        │     collected_at    │
│     error_message   │        └─────────────────────┘
│     created_at      │
│ IDX content_id      │
└─────────────────────┘


           ┌─────────────────────┐
           │   channel_configs   │
           ├─────────────────────┤
           │ PK  id              │
           │ FK  community_id    │
           │     channel         │
           │     config (JSON)   │
           │     enabled         │
           │ UQ(community_id,    │
           │    channel)         │
           └─────────────────────┘
```

### 3.2 索引设计

| 表名 | 索引字段 | 索引类型 | 用途 |
|------|---------|---------|------|
| users | username | UNIQUE | 登录查询 |
| users | email | UNIQUE | 邮箱唯一 |
| communities | slug | UNIQUE | URL友好标识 |
| community_users | (user_id, community_id) | UNIQUE | 防止重复加入 |
| contents | community_id | BTREE | 社区查询（最频繁） |
| contents | created_by_user_id | BTREE | 作者查询 |
| contents | scheduled_publish_at | BTREE | 日历视图查询 |
| contents | (community_id, status) | COMPOSITE | 看板视图查询 |
| channel_configs | (community_id, channel) | UNIQUE | 配置查询 |
| audit_logs | created_at | BTREE | 时间范围查询 |
| audit_logs | (user_id, created_at) | COMPOSITE | 用户操作历史 |

### 3.3 分区策略（未来扩展）

当audit_logs表超过100万条记录时，考虑按时间分区：

```sql
-- PostgreSQL示例
CREATE TABLE audit_logs (
    id SERIAL,
    created_at TIMESTAMP NOT NULL,
    ...
) PARTITION BY RANGE (created_at);

CREATE TABLE audit_logs_2026_q1 PARTITION OF audit_logs
    FOR VALUES FROM ('2026-01-01') TO ('2026-04-01');

CREATE TABLE audit_logs_2026_q2 PARTITION OF audit_logs
    FOR VALUES FROM ('2026-04-01') TO ('2026-07-01');
```

---

## 4. API设计

### 4.1 API设计原则

- **RESTful风格**: 资源定位使用名词，操作使用HTTP方法
- **统一响应格式**: 成功返回200/201，错误返回4xx/5xx + detail
- **版本控制**: 路径加/v1前缀（未来扩展）
- **分页标准**: `page`和`page_size`参数
- **过滤标准**: 查询参数，如`?status=draft&keyword=kubernetes`

### 4.2 API端点总览

| 模块 | 方法 | 路径 | 描述 |
|------|------|------|------|
| **认证** | POST | /api/auth/login | 登录 |
| | GET | /api/auth/me | 获取当前用户 |
| **社区** | GET | /api/communities | 社区列表 |
| | POST | /api/communities | 创建社区（超管） |
| | GET | /api/communities/{id} | 社区详情 |
| | PUT | /api/communities/{id} | 更新社区 |
| | DELETE | /api/communities/{id} | 删除社区 |
| | POST | /api/communities/{id}/users | 添加成员 |
| | DELETE | /api/communities/{id}/users/{uid} | 移除成员 |
| **内容** | GET | /api/contents | 内容列表（分页） |
| | POST | /api/contents | 创建内容 |
| | GET | /api/contents/{id} | 内容详情 |
| | PUT | /api/contents/{id} | 更新内容 |
| | DELETE | /api/contents/{id} | 删除内容 |
| | PATCH | /api/contents/{id}/status | 更新状态 |
| | PATCH | /api/contents/{id}/schedule | 设置计划时间 |
| | GET | /api/contents/calendar | 日历数据 |
| | GET | /api/contents/kanban | 看板数据 |
| | POST | /api/contents/batch-update-status | 批量更新状态 |
| **上传** | POST | /api/contents/upload | 上传DOCX/MD |
| | POST | /api/contents/{id}/cover | 上传封面图 |
| **发布** | POST | /api/publish/{id}/wechat | 发布到微信 |
| | POST | /api/publish/{id}/hugo | 发布到Hugo |
| | GET | /api/publish/{id}/preview/{channel} | 预览 |
| | GET | /api/publish/{id}/copy/{channel} | 获取复制内容 |
| | GET | /api/publish/records | 发布记录 |
| **分析** | GET | /api/analytics/overview | 概览统计 |
| | GET | /api/analytics/dashboard | 仪表板数据 |
| | GET | /api/analytics/by-channel | 按渠道统计 |
| | GET | /api/analytics/by-author | 按作者统计 |
| | GET | /api/analytics/trend | 趋势数据 |
| | GET | /api/analytics/category-distribution | 分类分布 |
| | GET | /api/analytics/settings/channels | 渠道配置列表 |
| | PUT | /api/analytics/settings/channels/{ch} | 更新渠道配置 |

### 4.3 请求/响应示例

#### 登录请求
```http
POST /api/auth/login
Content-Type: application/json

{
  "username": "admin",
  "password": "admin123"
}
```

**响应**:
```http
HTTP/1.1 200 OK
Content-Type: application/json

{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer"
}
```

#### 内容列表请求（带社区隔离）
```http
GET /api/contents?page=1&page_size=20&status=draft&keyword=k8s
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
X-Community-Id: 5
```

**响应**:
```http
HTTP/1.1 200 OK
Content-Type: application/json

{
  "items": [
    {
      "id": 123,
      "title": "Kubernetes 1.28 Release Note",
      "status": "draft",
      "author": "张三",
      "created_at": "2026-02-01T10:00:00Z"
    }
  ],
  "total": 45,
  "page": 1,
  "page_size": 20
}
```

### 4.4 错误码规范

| HTTP状态码 | 错误类型 | 示例场景 |
|-----------|---------|---------|
| 400 | Bad Request | 参数校验失败、缺少必填字段 |
| 401 | Unauthorized | Token无效或过期 |
| 403 | Forbidden | 无权访问该社区 |
| 404 | Not Found | 资源不存在 |
| 409 | Conflict | 社区slug重复 |
| 422 | Unprocessable Entity | 业务逻辑错误（如状态流转不合法） |
| 500 | Internal Server Error | 服务器内部错误 |
| 502 | Bad Gateway | 外部API调用失败（如微信API） |

**错误响应格式**:
```json
{
  "detail": "无权访问该社区"
}
```

---

## 5. 前端架构设计

### 5.1 组件层次结构

```
src/
├── main.ts                      # 应用入口
├── App.vue                      # 根组件
│
├── router/
│   └── index.ts                 # 路由配置
│
├── stores/                      # Pinia状态管理
│   ├── auth.ts                  # 认证状态
│   ├── community.ts             # 社区上下文
│   └── content.ts               # 内容缓存（可选）
│
├── api/                         # API客户端
│   ├── index.ts                 # Axios实例配置
│   ├── auth.ts                  # 认证API
│   ├── community.ts             # 社区API
│   ├── content.ts               # 内容API
│   ├── publish.ts               # 发布API
│   └── analytics.ts             # 分析API
│
├── views/                       # 页面组件
│   ├── Login.vue                # 登录页
│   ├── Dashboard.vue            # 仪表板
│   ├── ContentList.vue          # 内容列表
│   ├── ContentEdit.vue          # 内容编辑
│   ├── ContentCalendar.vue      # 日历视图 ⭐
│   ├── ContentKanban.vue        # 看板视图 ⭐
│   ├── PublishView.vue          # 发布管理
│   ├── AnalyticsDashboard.vue   # 数据分析 ⭐
│   ├── Settings.vue             # 设置
│   ├── CommunityManage.vue      # 社区管理
│   └── UserProfile.vue          # 用户资料
│
├── components/                  # 可复用组件
│   ├── CommunitySwitcher.vue    # 社区切换器 ⭐
│   ├── CalendarEventDialog.vue  # 日历事件对话框 ⭐
│   ├── KanbanCard.vue           # 看板卡片 ⭐
│   └── ChartCard.vue            # 图表容器 ⭐
│
├── composables/                 # 组合式函数
│   ├── useAuth.ts               # 认证逻辑
│   ├── useCommunity.ts          # 社区逻辑
│   └── usePermission.ts         # 权限判断
│
└── assets/                      # 静态资源
    ├── calendar.scss            # 日历样式 ⭐
    ├── kanban.scss              # 看板样式 ⭐
    └── analytics.scss           # 分析样式 ⭐
```

### 5.2 状态管理设计

#### auth.ts (认证状态)
```typescript
export const useAuthStore = defineStore('auth', () => {
  // State
  const token = ref<string | null>(localStorage.getItem('token'))
  const user = ref<User | null>(null)
  const communities = ref<Community[]>([])

  // Getters
  const isAuthenticated = computed(() => !!token.value && !!user.value)
  const isSuperuser = computed(() => user.value?.is_superuser === true)

  // Actions
  async function login(username: string, password: string) {
    const response = await api.post('/auth/login', { username, password })
    token.value = response.data.access_token
    localStorage.setItem('token', token.value!)
    await fetchUserInfo()
  }

  async function fetchUserInfo() {
    const response = await api.get('/auth/me')
    user.value = response.data.user
    communities.value = response.data.communities
  }

  function logout() {
    token.value = null
    user.value = null
    communities.value = []
    localStorage.removeItem('token')
    router.push('/login')
  }

  return { token, user, communities, isAuthenticated, isSuperuser, login, fetchUserInfo, logout }
})
```

#### community.ts (社区上下文)
```typescript
export const useCommunityStore = defineStore('community', () => {
  // State
  const currentCommunityId = ref<number | null>(
    parseInt(localStorage.getItem('currentCommunityId') || '0') || null
  )

  // Getters
  const hasSelectedCommunity = computed(() => currentCommunityId.value !== null)

  // Actions
  function setCommunity(id: number) {
    currentCommunityId.value = id
    localStorage.setItem('currentCommunityId', String(id))
  }

  function clearCommunity() {
    currentCommunityId.value = null
    localStorage.removeItem('currentCommunityId')
  }

  return { currentCommunityId, hasSelectedCommunity, setCommunity, clearCommunity }
})
```

### 5.3 路由守卫设计

```typescript
// router/index.ts

router.beforeEach(async (to, from, next) => {
  const authStore = useAuthStore()
  const communityStore = useCommunityStore()

  // 1. 检查认证
  if (to.meta.requiresAuth && !authStore.isAuthenticated) {
    return next('/login')
  }

  // 2. 检查社区选择
  if (to.meta.requiresCommunity && !communityStore.hasSelectedCommunity) {
    ElMessage.warning('请先选择社区')
    return next('/dashboard')
  }

  // 3. 检查超管权限
  if (to.meta.requiresSuperuser && !authStore.isSuperuser) {
    ElMessage.error('需要超级管理员权限')
    return next('/dashboard')
  }

  // 4. 已登录用户访问登录页，跳转到首页
  if (to.path === '/login' && authStore.isAuthenticated) {
    return next('/dashboard')
  }

  next()
})
```

### 5.4 Axios拦截器

```typescript
// api/index.ts

// 请求拦截器
api.interceptors.request.use(config => {
  const authStore = useAuthStore()
  const communityStore = useCommunityStore()

  // 添加Authorization头
  if (authStore.token) {
    config.headers.Authorization = `Bearer ${authStore.token}`
  }

  // 添加X-Community-Id头（除了登录、社区列表等公共API）
  if (communityStore.currentCommunityId && !config.url?.includes('/auth/')) {
    config.headers['X-Community-Id'] = String(communityStore.currentCommunityId)
  }

  return config
})

// 响应拦截器
api.interceptors.response.use(
  response => response,
  error => {
    if (error.response?.status === 401) {
      // Token过期或无效，清空状态并跳转登录
      const authStore = useAuthStore()
      authStore.logout()
      ElMessage.error('登录已过期，请重新登录')
    } else if (error.response?.status === 403) {
      ElMessage.error('无权访问该资源')
    }
    return Promise.reject(error)
  }
)
```

---

## 6. 安全架构设计

### 6.1 认证流程

```
┌────────┐           ┌──────────┐           ┌──────────┐
│ Client │           │   API    │           │   DB     │
└───┬────┘           └────┬─────┘           └────┬─────┘
    │                     │                      │
    │  1. POST /auth/login                      │
    │  {username, password}                     │
    ├────────────────────>│                      │
    │                     │  2. Query user       │
    │                     ├─────────────────────>│
    │                     │<─────────────────────┤
    │                     │  User record         │
    │                     │                      │
    │                     │  3. Verify password  │
    │                     │  (bcrypt.verify)     │
    │                     │──────┐               │
    │                     │      │               │
    │                     │<─────┘               │
    │                     │                      │
    │                     │  4. Create JWT       │
    │                     │  payload: {sub: id}  │
    │                     │──────┐               │
    │                     │      │               │
    │                     │<─────┘               │
    │  5. Return Token    │                      │
    │  {access_token}     │                      │
    │<────────────────────┤                      │
    │                     │                      │
    │  6. Store Token     │                      │
    │  (localStorage)     │                      │
    │──────┐              │                      │
    │      │              │                      │
    │<─────┘              │                      │
    │                     │                      │
    │  7. API Request     │                      │
    │  Header: Bearer {token}                   │
    ├────────────────────>│                      │
    │                     │  8. Verify JWT       │
    │                     │──────┐               │
    │                     │      │               │
    │                     │<─────┘               │
    │  9. Success         │                      │
    │<────────────────────┤                      │
```

### 6.2 密码安全

- **哈希算法**: bcrypt（成本因子12）
- **盐值**: 自动生成（bcrypt内置）
- **存储**: 仅存储哈希值，原始密码不可恢复
- **密码策略**: 最少8位，包含字母+数字（前端验证）

### 6.3 JWT Token设计

**Payload**:
```json
{
  "sub": "1",                    // 用户ID
  "exp": 1738934400,             // 过期时间（7天后）
  "iat": 1738329600              // 签发时间
}
```

**安全措施**:
- HTTPS传输
- HttpOnly Cookie（可选，当前使用localStorage）
- 短期有效（7天）
- 无刷新Token（简化实现）

### 6.4 CORS策略

```python
# main.py
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:5173"],  # 开发环境
    # allow_origins=["https://yourdomain.com"],  # 生产环境
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

### 6.5 输入验证

- **前端验证**: Element Plus表单验证
- **后端验证**: Pydantic Schema强类型验证
- **SQL注入防护**: SQLAlchemy ORM参数化查询
- **XSS防护**: Markdown渲染时转义HTML标签

---

## 7. 性能优化设计

### 7.1 数据库优化

| 优化项 | 策略 |
|--------|------|
| 索引优化 | 高频查询字段建立索引（community_id、status） |
| 分页查询 | LIMIT + OFFSET，避免全表扫描 |
| N+1问题 | 使用joinedload预加载关联数据 |
| 连接池 | SQLAlchemy连接池（默认5个） |
| 查询优化 | SELECT仅查询需要的字段，避免SELECT * |

### 7.2 前端性能优化

| 优化项 | 策略 |
|--------|------|
| 代码分割 | 路由懒加载（() => import()） |
| 图片懒加载 | vue-lazyload插件 |
| 防抖节流 | 搜索框300ms防抖 |
| 虚拟滚动 | 长列表使用vue-virtual-scroller |
| CDN加速 | Element Plus图标库使用CDN |
| 缓存策略 | Axios缓存GET请求结果（5分钟） |

### 7.3 缓存策略

```python
from functools import lru_cache

@lru_cache(maxsize=100)
def get_community_config(community_id: int, channel: str) -> dict:
    """缓存社区配置，减少数据库查询"""
    return db.query(ChannelConfig).filter(...).first()
```

### 7.4 异步处理

```python
# 微信API调用使用异步
async def create_draft(title: str, content: str):
    async with httpx.AsyncClient() as client:
        response = await client.post(url, json=data)
        return response.json()
```

---

## 8. 部署架构

### 8.1 开发环境

```
Developer Machine
├── Backend (localhost:8000)
│   └── uvicorn --reload
├── Frontend (localhost:5173)
│   └── npm run dev
└── SQLite (./content_hub.db)
```

### 8.2 生产环境（Docker Compose）

```yaml
version: '3.8'

services:
  backend:
    image: content-hub-backend:latest
    environment:
      - DATABASE_URL=postgresql://user:pass@postgres/content_hub
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
    depends_on:
      - postgres
    volumes:
      - ./uploads:/app/uploads

  frontend:
    image: content-hub-frontend:latest
    ports:
      - "80:80"

  postgres:
    image: postgres:15
    environment:
      - POSTGRES_DB=content_hub
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:
```

### 8.3 扩展架构（未来）

```
┌─────────────┐
│   Nginx LB  │
└──────┬──────┘
       │
       ├──────────┬──────────┐
       │          │          │
┌──────▼───┐ ┌───▼──────┐ ┌─▼─────────┐
│ Backend 1│ │Backend 2 │ │ Backend 3 │
└──────┬───┘ └───┬──────┘ └─┬─────────┘
       │          │          │
       └──────────┼──────────┘
                  │
          ┌───────▼───────┐
          │  PostgreSQL   │
          │  (Master)     │
          └───────┬───────┘
                  │
          ┌───────▼───────┐
          │  PostgreSQL   │
          │  (Replica)    │
          └───────────────┘
```

---

## 9. 监控与日志

### 9.1 日志设计

**日志级别**:
- DEBUG: 详细调试信息（开发环境）
- INFO: 关键业务流程（登录、发布）
- WARNING: 潜在问题（Token即将过期）
- ERROR: 错误但不影响服务（外部API调用失败）
- CRITICAL: 严重错误（数据库连接失败）

**日志格式**（JSON）:
```json
{
  "timestamp": "2026-02-06T10:30:00Z",
  "level": "INFO",
  "logger": "app.api.publish",
  "message": "发布到微信成功",
  "extra": {
    "user_id": 5,
    "community_id": 2,
    "content_id": 123,
    "channel": "wechat",
    "duration_ms": 2500
  }
}
```

### 9.2 监控指标

| 指标类型 | 具体指标 | 告警阈值 |
|---------|---------|---------|
| **系统指标** | CPU使用率 | >80% |
| | 内存使用率 | >85% |
| | 磁盘使用率 | >90% |
| **应用指标** | API响应时间P95 | >1s |
| | 错误率 | >5% |
| | 并发请求数 | >100 |
| **业务指标** | 登录失败率 | >10% |
| | 发布成功率 | <95% |
| | 日活用户数 | 趋势下降 |

### 9.3 审计日志查询

```sql
-- 查询某用户最近的操作
SELECT action, resource_type, resource_id, created_at
FROM audit_logs
WHERE user_id = 5
ORDER BY created_at DESC
LIMIT 50;

-- 查询某社区的发布操作
SELECT u.username, al.action, al.details, al.created_at
FROM audit_logs al
JOIN users u ON al.user_id = u.id
WHERE al.community_id = 2
  AND al.action LIKE 'publish_%'
ORDER BY al.created_at DESC;
```

---

## 10. 技术债务与改进计划

### 10.1 当前技术债务

| 债务项 | 影响 | 还债计划 |
|--------|------|---------|
| SQLite并发限制 | 中 | Phase 5迁移PostgreSQL |
| 缺少单元测试 | 高 | Phase 5补充测试（覆盖率>80%） |
| 前端状态管理简单 | 低 | 按需优化（Vuex → Pinia已完成） |
| 缺少CI/CD | 中 | Phase 6集成GitHub Actions |
| 审计日志无检索UI | 低 | Phase 6开发审计日志查询页面 |

### 10.2 架构演进路线

```
Phase 1-4: 多租户基础架构                    [当前阶段]
    ↓
Phase 5: PostgreSQL迁移 + 单元测试          [Q2 2026]
    ↓
Phase 6: CI/CD + 监控告警 + 审计日志UI      [Q3 2026]
    ↓
Phase 7: RBAC权限体系 + 工作流引擎          [Q4 2026]
    ↓
Phase 8: 移动端适配 + 多语言支持            [2027]
```

---

**文档状态**: ✅ 已评审通过
**评审人**: 架构师、技术负责人
**评审日期**: 2026-02-06
