# 理事会治理模块设计文档

**文档版本**: v1.0
**编写日期**: 2026-02-09
**适用项目**: openGecko - 企业级多社区内容管理平台

---

## 一、功能概述

### 1.1 业务背景

开源社区需要规范的治理结构来保证社区的健康发展。理事会（Board/Council）作为社区的最高决策机构，需要一个系统化的管理工具来：
- 管理多个委员会的组织架构
- 维护委员成员的详细信息和角色
- 安排和跟踪理事会会议
- 在关键时间节点提醒相关人员

### 1.2 核心功能

```
理事会治理模块
├── 委员会管理
│   ├── 创建/编辑/删除委员会
│   ├── 委员会列表与详情
│   └── 委员会状态管理
│
├── 成员管理
│   ├── 成员信息维护（姓名、联系方式）
│   ├── 角色标签管理（主席、副主席、委员、常务委员）
│   ├── 成员任期管理
│   └── 批量导入/导出
│
├── 会议管理
│   ├── 会议日历集成
│   ├── 会议议程编辑
│   ├── 会议纪要记录
│   └── 会议文件上传
│
└── 通知提醒
    ├── 关键时间点提醒
    ├── 邮件通知发送
    └── 微信通知发送（可选）
```

---

## 二、数据模型设计

### 2.1 委员会表 (committees)

```python
class Committee(Base):
    """委员会/理事会"""
    __tablename__ = "committees"

    # 基本信息
    id = Column(Integer, primary_key=True)
    community_id = Column(Integer, ForeignKey("communities.id"), nullable=False)
    name = Column(String(200), nullable=False)  # 委员会名称，如"技术委员会"
    slug = Column(String(100), nullable=False)  # URL友好标识
    description = Column(Text)                  # 委员会职责描述

    # 状态
    is_active = Column(Boolean, default=True)   # 是否活跃

    # 设置
    meeting_frequency = Column(String(50))      # 会议频率：monthly, quarterly, yearly
    notification_email = Column(String(200))    # 统一通知邮箱
    notification_wechat = Column(String(100))   # 统一通知微信号

    # 时间戳
    established_at = Column(DateTime)           # 成立时间
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, onupdate=datetime.utcnow)

    # 关系
    members = relationship("CommitteeMember", back_populates="committee", cascade="all, delete-orphan")
    meetings = relationship("Meeting", back_populates="committee", cascade="all, delete-orphan")

    # 索引和约束
    __table_args__ = (
        Index('idx_committee_community', 'community_id'),
        UniqueConstraint('community_id', 'slug', name='uq_committee_slug'),
    )
```

### 2.2 委员会成员表 (committee_members)

```python
class CommitteeMember(Base):
    """委员会成员"""
    __tablename__ = "committee_members"

    # 基本信息
    id = Column(Integer, primary_key=True)
    committee_id = Column(Integer, ForeignKey("committees.id"), nullable=False)

    # 成员信息
    name = Column(String(200), nullable=False)   # 姓名
    email = Column(String(200))                  # 邮箱
    phone = Column(String(50))                   # 电话
    wechat = Column(String(100))                 # 微信号
    organization = Column(String(200))           # 所属组织/公司

    # 角色标签（可多选，JSON数组）
    # ['chairman', 'vice_chairman', 'member', 'standing_member']
    roles = Column(JSON, default=list)

    # 任期
    term_start = Column(Date)                    # 任期开始
    term_end = Column(Date)                      # 任期结束
    is_active = Column(Boolean, default=True)    # 是否在任

    # 额外信息
    bio = Column(Text)                           # 个人简介
    avatar_url = Column(String(500))             # 头像URL

    # 时间戳
    joined_at = Column(DateTime, default=datetime.utcnow)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, onupdate=datetime.utcnow)

    # 关系
    committee = relationship("Committee", back_populates="members")

    # 索引
    __table_args__ = (
        Index('idx_member_committee', 'committee_id'),
        Index('idx_member_email', 'email'),
    )
```

### 2.3 会议表 (meetings)

```python
class Meeting(Base):
    """理事会会议"""
    __tablename__ = "meetings"

    # 基本信息
    id = Column(Integer, primary_key=True)
    committee_id = Column(Integer, ForeignKey("committees.id"), nullable=False)
    community_id = Column(Integer, ForeignKey("communities.id"), nullable=False)

    # 会议信息
    title = Column(String(500), nullable=False)  # 会议主题
    description = Column(Text)                   # 会议描述

    # 会议时间
    scheduled_at = Column(DateTime, nullable=False)  # 会议时间
    duration = Column(Integer, default=120)      # 持续时长（分钟）

    # 会议地点
    location_type = Column(String(50))           # online/offline/hybrid
    location = Column(String(500))               # 地点描述或视频会议链接

    # 会议状态
    status = Column(String(50), default='scheduled')  # scheduled, in_progress, completed, cancelled

    # 会议内容
    agenda = Column(Text)                        # 会议议程（Markdown）
    minutes = Column(Text)                       # 会议纪要（Markdown）
    attachments = Column(JSON, default=list)     # 附件列表 [{name, url}]

    # 提醒设置
    reminder_sent = Column(Boolean, default=False)       # 是否已发送提醒
    reminder_before_hours = Column(Integer, default=24)  # 提前多少小时提醒

    # 创建者
    created_by_user_id = Column(Integer, ForeignKey("users.id"))

    # 时间戳
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, onupdate=datetime.utcnow)

    # 关系
    committee = relationship("Committee", back_populates="meetings")
    created_by = relationship("User")

    # 索引
    __table_args__ = (
        Index('idx_meeting_committee', 'committee_id'),
        Index('idx_meeting_scheduled_at', 'scheduled_at'),
        Index('idx_meeting_status', 'status'),
    )
```

### 2.4 会议提醒记录表 (meeting_reminders)

```python
class MeetingReminder(Base):
    """会议提醒记录"""
    __tablename__ = "meeting_reminders"

    id = Column(Integer, primary_key=True)
    meeting_id = Column(Integer, ForeignKey("meetings.id"), nullable=False)

    # 提醒类型
    reminder_type = Column(String(50))  # preparation, one_week, one_day, one_hour

    # 提醒时间
    scheduled_at = Column(DateTime, nullable=False)
    sent_at = Column(DateTime)

    # 提醒渠道
    notification_channels = Column(JSON, default=list)  # ['email', 'wechat']

    # 发送状态
    status = Column(String(50), default='pending')  # pending, sent, failed
    error_message = Column(Text)

    # 时间戳
    created_at = Column(DateTime, default=datetime.utcnow)

    # 索引
    __table_args__ = (
        Index('idx_reminder_meeting', 'meeting_id'),
        Index('idx_reminder_scheduled', 'scheduled_at', 'status'),
    )
```

---

## 三、API设计

### 3.1 委员会管理 API

#### 委员会CRUD

```python
# GET /api/committees
# 获取当前社区的委员会列表
def list_committees(
    community_id: int = Depends(get_current_community),
    is_active: Optional[bool] = None
) -> List[CommitteeOut]:
    """返回委员会列表，包含成员数量统计"""
    pass

# POST /api/committees
# 创建委员会（需要社区管理员权限）
def create_committee(
    data: CommitteeCreate,
    community_id: int = Depends(get_current_community),
    user: User = Depends(get_current_user)
) -> CommitteeOut:
    """创建新委员会"""
    pass

# GET /api/committees/{id}
# 获取委员会详情
def get_committee(
    id: int,
    community_id: int = Depends(get_current_community)
) -> CommitteeWithMembers:
    """返回委员会详情，包含所有成员信息"""
    pass

# PUT /api/committees/{id}
# 更新委员会信息
def update_committee(
    id: int,
    data: CommitteeUpdate,
    community_id: int = Depends(get_current_community)
) -> CommitteeOut:
    pass

# DELETE /api/committees/{id}
# 删除委员会
def delete_committee(
    id: int,
    community_id: int = Depends(get_current_community)
):
    pass
```

### 3.2 成员管理 API

```python
# GET /api/committees/{committee_id}/members
# 获取委员会成员列表
def list_members(
    committee_id: int,
    role: Optional[str] = None,  # 按角色筛选
    is_active: Optional[bool] = True
) -> List[CommitteeMemberOut]:
    pass

# POST /api/committees/{committee_id}/members
# 添加成员
def add_member(
    committee_id: int,
    data: CommitteeMemberCreate
) -> CommitteeMemberOut:
    pass

# PUT /api/committees/{committee_id}/members/{member_id}
# 更新成员信息
def update_member(
    committee_id: int,
    member_id: int,
    data: CommitteeMemberUpdate
) -> CommitteeMemberOut:
    pass

# DELETE /api/committees/{committee_id}/members/{member_id}
# 移除成员
def remove_member(
    committee_id: int,
    member_id: int
):
    pass

# POST /api/committees/{committee_id}/members/batch-import
# 批量导入成员（CSV/Excel）
def batch_import_members(
    committee_id: int,
    file: UploadFile
) -> BatchImportResult:
    pass

# GET /api/committees/{committee_id}/members/export
# 导出成员列表（CSV）
def export_members(
    committee_id: int
) -> FileResponse:
    pass
```

### 3.3 会议管理 API

```python
# GET /api/meetings
# 获取会议列表（支持日历视图）
def list_meetings(
    community_id: int = Depends(get_current_community),
    committee_id: Optional[int] = None,
    start_date: Optional[date] = None,
    end_date: Optional[date] = None,
    status: Optional[str] = None
) -> List[MeetingOut]:
    """返回会议列表，用于日历展示"""
    pass

# POST /api/meetings
# 创建会议
def create_meeting(
    data: MeetingCreate,
    user: User = Depends(get_current_user)
) -> MeetingOut:
    """创建会议并自动设置提醒"""
    pass

# GET /api/meetings/{id}
# 获取会议详情
def get_meeting(
    id: int,
    community_id: int = Depends(get_current_community)
) -> MeetingDetail:
    """返回会议详情，包含议程、纪要、附件"""
    pass

# PUT /api/meetings/{id}
# 更新会议信息
def update_meeting(
    id: int,
    data: MeetingUpdate
) -> MeetingOut:
    pass

# DELETE /api/meetings/{id}
# 删除会议
def delete_meeting(id: int):
    pass

# POST /api/meetings/{id}/remind
# 手动发送会议提醒
def send_meeting_reminder(
    id: int,
    channels: List[str] = ['email', 'wechat']
):
    """立即发送会议提醒给所有委员会成员"""
    pass

# POST /api/meetings/{id}/minutes
# 上传/更新会议纪要
def update_minutes(
    id: int,
    minutes: str
) -> MeetingOut:
    pass
```

### 3.4 数据Schema定义

```python
# Pydantic Schemas

class CommitteeCreate(BaseModel):
    name: str
    slug: str
    description: Optional[str]
    meeting_frequency: Optional[str]
    notification_email: Optional[str]
    notification_wechat: Optional[str]
    established_at: Optional[datetime]

class CommitteeOut(BaseModel):
    id: int
    name: str
    slug: str
    description: Optional[str]
    is_active: bool
    meeting_frequency: Optional[str]
    established_at: Optional[datetime]
    member_count: int  # 计算属性
    created_at: datetime

class CommitteeMemberCreate(BaseModel):
    name: str
    email: Optional[EmailStr]
    phone: Optional[str]
    wechat: Optional[str]
    organization: Optional[str]
    roles: List[str] = []  # ['chairman', 'vice_chairman', 'member', 'standing_member']
    term_start: Optional[date]
    term_end: Optional[date]
    bio: Optional[str]

class CommitteeMemberOut(BaseModel):
    id: int
    name: str
    email: Optional[str]
    phone: Optional[str]
    wechat: Optional[str]
    organization: Optional[str]
    roles: List[str]
    term_start: Optional[date]
    term_end: Optional[date]
    is_active: bool
    joined_at: datetime

class MeetingCreate(BaseModel):
    committee_id: int
    title: str
    description: Optional[str]
    scheduled_at: datetime
    duration: int = 120
    location_type: str = 'online'
    location: Optional[str]
    agenda: Optional[str]
    reminder_before_hours: int = 24

class MeetingOut(BaseModel):
    id: int
    committee_id: int
    title: str
    scheduled_at: datetime
    duration: int
    location_type: str
    location: Optional[str]
    status: str
    created_at: datetime
```

---

## 四、前端页面设计

### 4.1 页面结构

```
前端页面
├── GovernanceOverview.vue       # 治理概览（总仪表板）
├── CommitteeList.vue            # 委员会列表页
├── CommitteeDetail.vue          # 委员会详情页
├── CommitteeMemberManage.vue    # 成员管理页
├── MeetingCalendar.vue          # 会议日历（复用内容日历）
├── MeetingDetail.vue            # 会议详情页
└── MeetingCreate.vue            # 创建/编辑会议页
```

### 4.2 组件设计

```
共享组件
├── RoleBadge.vue               # 角色徽章组件
├── MemberCard.vue              # 成员卡片组件
├── MeetingAgendaEditor.vue     # 议程编辑器
└── NotificationSettings.vue    # 通知设置组件
```

### 4.3 路由配置

```typescript
routes = [
  {
    path: '/governance',
    meta: { requiresAuth: true },
    children: [
      {
        path: '',
        component: GovernanceOverview,
        name: 'governance-overview'
      },
      {
        path: 'committees',
        component: CommitteeList,
        name: 'committee-list'
      },
      {
        path: 'committees/:id',
        component: CommitteeDetail,
        name: 'committee-detail'
      },
      {
        path: 'committees/:id/members',
        component: CommitteeMemberManage,
        name: 'committee-members'
      },
      {
        path: 'meetings',
        component: MeetingCalendar,
        name: 'meeting-calendar'
      },
      {
        path: 'meetings/:id',
        component: MeetingDetail,
        name: 'meeting-detail'
      }
    ]
  }
]
```

---

## 五、通知提醒机制

### 5.1 关键时间点定义

```python
# 会议准备阶段的关键时间点
REMINDER_SCHEDULES = {
    'preparation': -7 * 24,      # 会前7天（准备阶段开始）
    'one_week': -7 * 24,         # 会前1周
    'three_days': -3 * 24,       # 会前3天
    'one_day': -24,              # 会前1天
    'two_hours': -2,             # 会前2小时
}
```

### 5.2 通知发送服务

```python
# services/notification.py

class NotificationService:
    """通知服务"""

    async def send_meeting_reminder(
        self,
        meeting: Meeting,
        members: List[CommitteeMember],
        reminder_type: str
    ):
        """发送会议提醒"""
        for member in members:
            # 邮件通知
            if member.email:
                await self.send_email_reminder(meeting, member, reminder_type)

            # 微信通知（可选，需要企业微信API）
            if member.wechat and meeting.committee.notification_wechat:
                await self.send_wechat_reminder(meeting, member, reminder_type)

    async def send_email_reminder(
        self,
        meeting: Meeting,
        member: CommitteeMember,
        reminder_type: str
    ):
        """发送邮件提醒"""
        subject = f"【{meeting.committee.name}】会议提醒：{meeting.title}"

        body = f"""
        尊敬的 {member.name}：

        这是一封会议提醒邮件。

        委员会：{meeting.committee.name}
        会议主题：{meeting.title}
        会议时间：{meeting.scheduled_at.strftime('%Y年%m月%d日 %H:%M')}
        会议地点：{meeting.location}
        会议时长：{meeting.duration}分钟

        会议议程：
        {meeting.agenda}

        请准时参会。

        ---
        此邮件由 openGecko 自动发送
        """

        await send_email(to=member.email, subject=subject, body=body)
```

### 5.3 定时任务

```python
# tasks/meeting_reminders.py

from celery import Celery
from datetime import datetime, timedelta

app = Celery('opengecko')

@app.task
def check_and_send_reminders():
    """检查并发送会议提醒"""
    now = datetime.utcnow()

    # 查询未来需要提醒的会议
    for reminder_type, hours_before in REMINDER_SCHEDULES.items():
        target_time = now + timedelta(hours=hours_before)

        # 查找符合条件的会议
        meetings = db.query(Meeting).filter(
            Meeting.scheduled_at.between(
                target_time - timedelta(minutes=30),
                target_time + timedelta(minutes=30)
            ),
            Meeting.status == 'scheduled'
        ).all()

        for meeting in meetings:
            # 检查是否已发送过该类型提醒
            existing = db.query(MeetingReminder).filter(
                MeetingReminder.meeting_id == meeting.id,
                MeetingReminder.reminder_type == reminder_type,
                MeetingReminder.status == 'sent'
            ).first()

            if not existing:
                # 发送提醒
                members = meeting.committee.members
                NotificationService().send_meeting_reminder(
                    meeting, members, reminder_type
                )

                # 记录提醒
                reminder = MeetingReminder(
                    meeting_id=meeting.id,
                    reminder_type=reminder_type,
                    scheduled_at=target_time,
                    sent_at=now,
                    status='sent'
                )
                db.add(reminder)
                db.commit()
```

---

## 六、安全与权限

### 6.1 权限控制

```python
# 权限级别
# 1. 社区管理员/超级管理员：完全控制
# 2. 委员会成员：查看权限
# 3. 其他用户：无权限

def check_committee_permission(
    committee_id: int,
    user: User,
    db: Session,
    action: str = 'read'
) -> bool:
    """检查委员会权限"""

    # 超级管理员/社区管理员
    if user.is_superuser or is_community_admin(user, committee.community_id):
        return True

    # 委员会成员（只读）
    if action == 'read':
        member = db.query(CommitteeMember).filter(
            CommitteeMember.committee_id == committee_id,
            CommitteeMember.email == user.email,
            CommitteeMember.is_active == True
        ).first()
        return member is not None

    return False
```

### 6.2 数据隐私

- 成员联系方式仅对社区管理员可见
- 会议纪要支持权限分级（公开/内部/机密）
- 审计日志记录所有敏感操作

---

## 七、实施优先级

### P0 - 核心功能（MVP）
- 委员会CRUD
- 成员管理（基本信息+角色）
- 会议基本管理
- 会议日历集成

### P1 - 增强功能
- 邮件通知
- 会议纪要编辑
- 成员批量导入

### P2 - 高级功能
- 微信通知
- 会议录音/视频
- 投票决议功能

---

## 八、技术实现要点

### 8.1 角色标签实现

```python
# 角色枚举
ROLE_CHOICES = {
    'chairman': '主席',
    'vice_chairman': '副主席',
    'member': '委员',
    'standing_member': '常务委员'
}

# 前端显示示例
def format_roles(roles: List[str]) -> str:
    """格式化角色显示"""
    return ', '.join([ROLE_CHOICES.get(r, r) for r in roles])

# 示例输出："主席, 常务委员"
```

### 8.2 日历事件整合

```typescript
// 将会议数据转换为日历事件格式
function convertMeetingToCalendarEvent(meeting: Meeting): CalendarEvent {
  return {
    id: `meeting-${meeting.id}`,
    title: `【会议】${meeting.title}`,
    start: meeting.scheduled_at,
    end: addMinutes(meeting.scheduled_at, meeting.duration),
    backgroundColor: '#3498db',  // 会议用蓝色
    extendedProps: {
      type: 'meeting',
      committee_name: meeting.committee.name,
      location: meeting.location
    }
  }
}
```

### 8.3 CSV导入模板

```csv
姓名,邮箱,电话,微信,所属组织,角色,任期开始,任期结束
张三,zhangsan@example.com,13800138000,wx_zhangsan,公司A,"chairman,standing_member",2024-01-01,2025-12-31
李四,lisi@example.com,13900139000,wx_lisi,公司B,member,2024-01-01,2025-12-31
```

---

## 九、数据库迁移

### 9.1 迁移脚本

```python
# alembic/versions/004_add_governance_module.py

def upgrade():
    # 创建委员会表
    op.create_table(
        'committees',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('community_id', sa.Integer(), nullable=False),
        sa.Column('name', sa.String(200), nullable=False),
        sa.Column('slug', sa.String(100), nullable=False),
        # ... 其他字段
        sa.ForeignKeyConstraint(['community_id'], ['communities.id']),
        sa.PrimaryKeyConstraint('id')
    )

    # 创建成员表
    op.create_table('committee_members', ...)

    # 创建会议表
    op.create_table('meetings', ...)

    # 创建提醒表
    op.create_table('meeting_reminders', ...)

def downgrade():
    op.drop_table('meeting_reminders')
    op.drop_table('meetings')
    op.drop_table('committee_members')
    op.drop_table('committees')
```

---

## 十、测试策略

### 10.1 单元测试

```python
# tests/test_governance.py

def test_create_committee():
    """测试创建委员会"""
    response = client.post("/api/committees", json={
        "name": "技术委员会",
        "slug": "tech-committee",
        "description": "负责技术决策"
    }, headers=auth_headers)
    assert response.status_code == 200
    assert response.json()["name"] == "技术委员会"

def test_add_member_with_multiple_roles():
    """测试添加多角色成员"""
    response = client.post(f"/api/committees/{committee_id}/members", json={
        "name": "张三",
        "email": "zhangsan@example.com",
        "roles": ["chairman", "standing_member"]
    }, headers=auth_headers)
    assert response.status_code == 200
    assert "chairman" in response.json()["roles"]
    assert "standing_member" in response.json()["roles"]
```

---

## 十一、文档与培训

### 11.1 用户手册

- 如何创建委员会
- 如何添加成员并分配角色
- 如何安排会议
- 如何配置提醒

### 11.2 管理员手册

- 权限配置
- 邮件服务器配置
- 批量导入操作
- 数据备份

---

**文档状态**: ✅ 设计完成，待审核
**下一步**: 分配开发任务，开始实施
