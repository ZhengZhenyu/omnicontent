# OmniContent - 数据库详细设计文档

**文档版本**: v2.0
**编写日期**: 2026-02-06
**数据库类型**: SQLite 3.35+ (开发) / PostgreSQL 15+ (生产)

---

## 1. 数据库概览

### 1.1 设计原则

| 原则 | 说明 |
|------|------|
| **范式化** | 符合第三范式(3NF)，减少冗余 |
| **多租户隔离** | community_id作为隔离字段 |
| **审计可追溯** | 关键操作记录到audit_logs |
| **软删除** | 重要数据使用is_active标记而非物理删除 |
| **时间戳** | 所有表包含created_at, updated_at |
| **外键约束** | 保证数据完整性 |

### 1.2 表清单

| 表名 | 行数估算 | 说明 |
|------|---------|------|
| users | 50 | 用户表 |
| communities | 10 | 社区表 |
| community_users | 100 | 用户-社区关联表 |
| contents | 12,000 (5年) | 内容表 |
| publish_records | 48,000 (5年) | 发布记录表 |
| content_analytics | 48,000 (5年) | 内容分析数据表 |
| channel_configs | 40 | 渠道配置表（10社区×4渠道） |
| audit_logs | 120,000 (5年) | 审计日志表 |

---

## 2. 表结构详细设计

### 2.1 users（用户表）

**用途**: 存储用户账号信息

```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username VARCHAR(100) NOT NULL UNIQUE,
    email VARCHAR(200) NOT NULL UNIQUE,
    hashed_password VARCHAR(200) NOT NULL,
    full_name VARCHAR(200) DEFAULT '',
    is_active BOOLEAN DEFAULT TRUE,
    is_superuser BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_username (username),
    INDEX idx_email (email)
);
```

**字段说明**:

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | INTEGER | PK, AUTO_INCREMENT | 主键 |
| username | VARCHAR(100) | NOT NULL, UNIQUE | 登录用户名，唯一 |
| email | VARCHAR(200) | NOT NULL, UNIQUE | 邮箱地址，唯一 |
| hashed_password | VARCHAR(200) | NOT NULL | bcrypt哈希后的密码 |
| full_name | VARCHAR(200) | | 用户全名/昵称 |
| is_active | BOOLEAN | DEFAULT TRUE | 是否激活（软删除） |
| is_superuser | BOOLEAN | DEFAULT FALSE | 是否超级管理员 |
| created_at | TIMESTAMP | DEFAULT NOW | 创建时间 |

**索引策略**:
- `idx_username`: 登录查询（高频）
- `idx_email`: 邮箱查询

**业务规则**:
- username和email全局唯一
- 密码必须经过bcrypt哈希（成本因子12）
- 超级管理员可跨社区访问所有数据

**示例数据**:
```sql
INSERT INTO users (id, username, email, hashed_password, full_name, is_superuser) VALUES
(1, 'admin', 'admin@example.com', '$2b$12$...', 'System Admin', TRUE),
(2, 'zhangsan', 'zhangsan@k8s.com', '$2b$12$...', '张三', FALSE);
```

---

### 2.2 communities（社区表）

**用途**: 存储社区（租户）信息

```sql
CREATE TABLE communities (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(200) NOT NULL UNIQUE,
    slug VARCHAR(100) NOT NULL UNIQUE,
    description TEXT DEFAULT '',
    logo_url VARCHAR(500),
    settings JSON DEFAULT '{}',
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_slug (slug),
    CHECK (slug = LOWER(slug))  -- slug必须小写
);
```

**字段说明**:

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | INTEGER | PK | 社区ID |
| name | VARCHAR(200) | NOT NULL, UNIQUE | 社区名称（显示用） |
| slug | VARCHAR(100) | NOT NULL, UNIQUE | URL友好标识（小写） |
| description | TEXT | | 社区描述 |
| logo_url | VARCHAR(500) | | Logo图片URL |
| settings | JSON | DEFAULT {} | 社区级设置（时区、语言等） |
| is_active | BOOLEAN | DEFAULT TRUE | 是否活跃 |
| created_at | TIMESTAMP | DEFAULT NOW | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT NOW | 更新时间 |

**索引策略**:
- `idx_slug`: URL路由查询

**业务规则**:
- name和slug全局唯一
- slug必须小写字母+数字+中划线
- settings为JSON字段，可存储社区特定配置

**示例数据**:
```sql
INSERT INTO communities (id, name, slug, description) VALUES
(1, 'Kubernetes Community', 'kubernetes', 'Cloud Native Container Orchestration'),
(2, 'Prometheus Community', 'prometheus', 'Monitoring and Alerting Toolkit');
```

---

### 2.3 community_users（用户-社区关联表）

**用途**: 多对多关系，用户可属于多个社区

```sql
CREATE TABLE community_users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    community_id INTEGER NOT NULL,
    role VARCHAR(50) DEFAULT 'member',
    joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (community_id) REFERENCES communities(id) ON DELETE CASCADE,

    UNIQUE (user_id, community_id),
    INDEX idx_user_id (user_id),
    INDEX idx_community_id (community_id)
);
```

**字段说明**:

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | INTEGER | PK | 主键 |
| user_id | INTEGER | NOT NULL, FK | 用户ID |
| community_id | INTEGER | NOT NULL, FK | 社区ID |
| role | VARCHAR(50) | DEFAULT 'member' | 角色（预留，暂未使用） |
| joined_at | TIMESTAMP | DEFAULT NOW | 加入时间 |

**索引策略**:
- `UNIQUE(user_id, community_id)`: 防止重复加入
- `idx_user_id`: 查询用户所属社区
- `idx_community_id`: 查询社区成员列表

**业务规则**:
- 一个用户可加入多个社区
- 超级管理员自动拥有所有社区权限（不需要记录）

**示例数据**:
```sql
INSERT INTO community_users (user_id, community_id, role) VALUES
(2, 1, 'member'),  -- 张三加入Kubernetes社区
(2, 2, 'member');  -- 张三加入Prometheus社区
```

---

### 2.4 contents（内容表）⭐核心表

**用途**: 存储所有内容记录

```sql
CREATE TABLE contents (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    community_id INTEGER NOT NULL,
    created_by_user_id INTEGER,
    title VARCHAR(500) NOT NULL,
    content_markdown TEXT DEFAULT '',
    content_html TEXT DEFAULT '',
    source_type VARCHAR(50) DEFAULT 'contribution',  -- contribution, release_note, event_summary
    source_file VARCHAR(500),
    author VARCHAR(200) DEFAULT '',
    tags JSON DEFAULT '[]',
    category VARCHAR(100) DEFAULT '',
    cover_image VARCHAR(500),
    status VARCHAR(50) DEFAULT 'draft',  -- draft, reviewing, approved, published
    scheduled_publish_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (community_id) REFERENCES communities(id) ON DELETE CASCADE,
    FOREIGN KEY (created_by_user_id) REFERENCES users(id) ON DELETE SET NULL,

    INDEX idx_community_id (community_id),
    INDEX idx_created_by_user_id (created_by_user_id),
    INDEX idx_scheduled_publish_at (scheduled_publish_at),
    INDEX idx_community_status (community_id, status),  -- 看板查询优化
    CHECK (status IN ('draft', 'reviewing', 'approved', 'published'))
);
```

**字段说明**:

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | INTEGER | PK | 内容ID |
| community_id | INTEGER | NOT NULL, FK | **隔离字段**，所属社区 |
| created_by_user_id | INTEGER | FK | 创建者ID |
| title | VARCHAR(500) | NOT NULL | 内容标题 |
| content_markdown | TEXT | | Markdown格式正文 |
| content_html | TEXT | | HTML格式正文（缓存） |
| source_type | VARCHAR(50) | | 来源类型 |
| source_file | VARCHAR(500) | | 上传的源文件名 |
| author | VARCHAR(200) | | 作者姓名（可能不是系统用户） |
| tags | JSON | DEFAULT [] | 标签数组 |
| category | VARCHAR(100) | | 分类 |
| cover_image | VARCHAR(500) | | 封面图路径 |
| status | VARCHAR(50) | CHECK | 状态（4种） |
| scheduled_publish_at | TIMESTAMP | | **日历功能**，计划发布时间 |
| created_at | TIMESTAMP | DEFAULT NOW | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT NOW | 更新时间 |

**索引策略**:
- `idx_community_id`: 最频繁查询（社区过滤）
- `idx_community_status`: 看板视图组合索引
- `idx_scheduled_publish_at`: 日历视图范围查询
- `idx_created_by_user_id`: 按作者查询

**业务规则**:
- 删除社区时级联删除内容（ON DELETE CASCADE）
- 删除用户时保留内容，created_by_user_id置为NULL
- status只能是4种枚举值之一
- tags存储为JSON数组，如 `["kubernetes", "release"]`

**示例数据**:
```sql
INSERT INTO contents (id, community_id, created_by_user_id, title, status, scheduled_publish_at) VALUES
(123, 1, 2, 'Kubernetes 1.28 Release Note', 'published', '2026-03-01 10:00:00'),
(124, 1, 2, 'K8s Best Practices 2026', 'draft', '2026-03-15 09:00:00');
```

---

### 2.5 publish_records（发布记录表）

**用途**: 记录内容在各渠道的发布情况

```sql
CREATE TABLE publish_records (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    content_id INTEGER NOT NULL,
    channel VARCHAR(50) NOT NULL,  -- wechat, hugo, csdn, zhihu
    status VARCHAR(50) DEFAULT 'pending',  -- pending, draft, published, failed
    platform_article_id VARCHAR(200),
    platform_url VARCHAR(500),
    published_at TIMESTAMP,
    error_message TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (content_id) REFERENCES contents(id) ON DELETE CASCADE,

    INDEX idx_content_id (content_id),
    INDEX idx_channel (channel),
    INDEX idx_status (status),
    CHECK (channel IN ('wechat', 'hugo', 'csdn', 'zhihu')),
    CHECK (status IN ('pending', 'draft', 'published', 'failed'))
);
```

**字段说明**:

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | INTEGER | PK | 记录ID |
| content_id | INTEGER | NOT NULL, FK | 关联内容ID |
| channel | VARCHAR(50) | NOT NULL, CHECK | 发布渠道 |
| status | VARCHAR(50) | CHECK | 发布状态 |
| platform_article_id | VARCHAR(200) | | 平台返回的文章ID |
| platform_url | VARCHAR(500) | | 平台文章URL |
| published_at | TIMESTAMP | | 发布成功时间 |
| error_message | TEXT | | 失败时的错误信息 |
| created_at | TIMESTAMP | DEFAULT NOW | 记录创建时间 |

**索引策略**:
- `idx_content_id`: 查询某内容的所有发布记录
- `idx_channel`: 按渠道统计
- `idx_status`: 按状态筛选

**业务规则**:
- 同一内容可发布到多个渠道（一对多）
- 删除内容时级联删除发布记录
- 微信渠道status为draft表示草稿已创建，published表示用户手动发布

**示例数据**:
```sql
INSERT INTO publish_records (content_id, channel, status, platform_url, published_at) VALUES
(123, 'wechat', 'published', 'https://mp.weixin.qq.com/s/xxx', '2026-03-01 10:30:00'),
(123, 'hugo', 'published', 'https://blog.k8s.io/2026/03/release-1.28', '2026-03-01 10:05:00');
```

---

### 2.6 content_analytics（内容分析数据表）

**用途**: 存储各渠道的阅读、互动数据

```sql
CREATE TABLE content_analytics (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    publish_record_id INTEGER NOT NULL,
    read_count INTEGER DEFAULT 0,
    like_count INTEGER DEFAULT 0,
    share_count INTEGER DEFAULT 0,
    comment_count INTEGER DEFAULT 0,
    collected_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (publish_record_id) REFERENCES publish_records(id) ON DELETE CASCADE,

    INDEX idx_publish_record_id (publish_record_id),
    INDEX idx_collected_at (collected_at)
);
```

**字段说明**:

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | INTEGER | PK | 主键 |
| publish_record_id | INTEGER | NOT NULL, FK | 关联发布记录 |
| read_count | INTEGER | DEFAULT 0 | 阅读数 |
| like_count | INTEGER | DEFAULT 0 | 点赞数 |
| share_count | INTEGER | DEFAULT 0 | 分享数 |
| comment_count | INTEGER | DEFAULT 0 | 评论数 |
| collected_at | TIMESTAMP | DEFAULT NOW | 数据采集时间 |

**业务规则**:
- 一个发布记录可有多条分析数据（按时间采集）
- 微信数据通过API定期同步
- CSDN/知乎数据手动录入

**示例数据**:
```sql
INSERT INTO content_analytics (publish_record_id, read_count, like_count, share_count) VALUES
(1, 5000, 120, 80);  -- 微信公众号数据
```

---

### 2.7 channel_configs（渠道配置表）

**用途**: 存储社区级的渠道配置（多租户隔离）

```sql
CREATE TABLE channel_configs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    community_id INTEGER NOT NULL,
    channel VARCHAR(50) NOT NULL,  -- wechat, hugo, csdn, zhihu
    config JSON NOT NULL DEFAULT '{}',
    enabled BOOLEAN DEFAULT TRUE,

    FOREIGN KEY (community_id) REFERENCES communities(id) ON DELETE CASCADE,

    UNIQUE (community_id, channel),
    INDEX idx_community_channel (community_id, channel),
    CHECK (channel IN ('wechat', 'hugo', 'csdn', 'zhihu'))
);
```

**字段说明**:

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | INTEGER | PK | 主键 |
| community_id | INTEGER | NOT NULL, FK | **隔离字段**，所属社区 |
| channel | VARCHAR(50) | NOT NULL, CHECK | 渠道类型 |
| config | JSON | NOT NULL | 渠道配置JSON |
| enabled | BOOLEAN | DEFAULT TRUE | 是否启用 |

**config字段结构**:

**微信公众号**:
```json
{
  "app_id": "wx1234567890abcdef",
  "app_secret": "secret_key_encrypted"
}
```

**Hugo博客**:
```json
{
  "repo_path": "/path/to/hugo/repo",
  "content_dir": "content/posts"
}
```

**索引策略**:
- `UNIQUE(community_id, channel)`: 每个社区每个渠道只有一条配置

**业务规则**:
- 社区级配置，不同社区的配置完全独立
- app_secret等敏感信息加密存储（未来扩展）

**示例数据**:
```sql
INSERT INTO channel_configs (community_id, channel, config, enabled) VALUES
(1, 'wechat', '{"app_id": "wx123", "app_secret": "secret"}', TRUE),
(1, 'hugo', '{"repo_path": "/repos/k8s-blog", "content_dir": "content/posts"}', TRUE);
```

---

### 2.8 audit_logs（审计日志表）

**用途**: 记录用户的关键操作，满足合规要求

```sql
CREATE TABLE audit_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    community_id INTEGER,
    action VARCHAR(100) NOT NULL,
    resource_type VARCHAR(50) NOT NULL,
    resource_id INTEGER,
    details JSON DEFAULT '{}',
    ip_address VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (community_id) REFERENCES communities(id) ON DELETE CASCADE,

    INDEX idx_user_id (user_id),
    INDEX idx_community_id (community_id),
    INDEX idx_created_at (created_at),
    INDEX idx_user_created (user_id, created_at)  -- 用户操作历史查询优化
);
```

**字段说明**:

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | INTEGER | PK | 日志ID |
| user_id | INTEGER | NOT NULL, FK | 操作用户 |
| community_id | INTEGER | FK | 操作所在社区 |
| action | VARCHAR(100) | NOT NULL | 操作类型 |
| resource_type | VARCHAR(50) | NOT NULL | 资源类型 |
| resource_id | INTEGER | | 资源ID |
| details | JSON | DEFAULT {} | 详细信息JSON |
| ip_address | VARCHAR(50) | | 客户端IP |
| created_at | TIMESTAMP | DEFAULT NOW | 操作时间 |

**action枚举值示例**:
- `login` - 登录
- `logout` - 登出
- `create_content` - 创建内容
- `update_content` - 更新内容
- `delete_content` - 删除内容
- `publish_to_wechat` - 发布到微信
- `schedule_content` - 日历排期
- `change_status` - 改变内容状态（看板拖拽）
- `create_community` - 创建社区（超管）

**resource_type枚举值**:
- `user`
- `community`
- `content`
- `channel_config`

**details字段示例**:
```json
{
  "old_status": "draft",
  "new_status": "reviewing",
  "method": "kanban_drag"
}
```

**索引策略**:
- `idx_created_at`: 按时间范围查询
- `idx_user_created`: 查询某用户的操作历史

**业务规则**:
- 审计日志只增不改（Append-Only）
- 保留期限：永久（超过3年归档到冷存储）
- 不记录敏感信息（密码、Token）

**示例数据**:
```sql
INSERT INTO audit_logs (user_id, community_id, action, resource_type, resource_id, details, ip_address) VALUES
(2, 1, 'publish_to_wechat', 'content', 123, '{"channel": "wechat", "status": "success"}', '192.168.1.100');
```

---

## 3. 数据字典

### 3.1 枚举值定义

#### source_type（内容来源）
| 值 | 说明 | 示例 |
|----|------|------|
| contribution | 社区投稿 | 用户提交的技术文章 |
| release_note | 发版说明 | Kubernetes 1.28版本更新说明 |
| event_summary | 活动总结 | KubeCon 2026参会总结 |

#### status（内容状态）
| 值 | 说明 | 可流转到 |
|----|------|---------|
| draft | 草稿 | reviewing, published |
| reviewing | 审核中 | approved, draft |
| approved | 已通过 | published, draft |
| published | 已发布 | - |

#### channel（渠道）
| 值 | 说明 | 发布方式 |
|----|------|---------|
| wechat | 微信公众号 | API自动创建草稿 |
| hugo | Hugo博客 | 生成Markdown文件 |
| csdn | CSDN | 复制粘贴 |
| zhihu | 知乎 | 复制粘贴 |

#### publish_record.status（发布状态）
| 值 | 说明 |
|----|------|
| pending | 待发布 |
| draft | 草稿已创建（微信） |
| published | 已发布 |
| failed | 发布失败 |

### 3.2 JSON字段结构

#### contents.tags
```json
["kubernetes", "cloud-native", "release"]
```

#### communities.settings
```json
{
  "timezone": "Asia/Shanghai",
  "language": "zh-CN",
  "notification_email": "admin@k8s.com"
}
```

#### audit_logs.details
```json
{
  "old_value": "draft",
  "new_value": "reviewing",
  "trigger": "manual_button_click"
}
```

---

## 4. 索引设计总结

### 4.1 索引类型

| 索引类型 | 用途 | 示例 |
|---------|------|------|
| 主键索引 | 唯一标识 | id (所有表) |
| 唯一索引 | 业务唯一性 | username, email, slug |
| 单列索引 | 高频查询字段 | community_id, status |
| 组合索引 | 多条件查询 | (community_id, status) |
| 外键索引 | 关联查询 | user_id, content_id |

### 4.2 索引优化策略

**高频查询优化**:
```sql
-- 看板视图查询（最频繁）
SELECT * FROM contents WHERE community_id = ? AND status = ?;
-- 索引：idx_community_status (community_id, status)

-- 日历视图查询
SELECT * FROM contents WHERE community_id = ? AND scheduled_publish_at BETWEEN ? AND ?;
-- 索引：idx_community_id + idx_scheduled_publish_at

-- 发布记录查询
SELECT * FROM publish_records WHERE content_id = ?;
-- 索引：idx_content_id
```

---

## 5. 数据迁移方案

### 5.1 Alembic迁移脚本结构

```
alembic/versions/
├── 001_add_multi_tenancy.py        # Phase 1: 多租户基础
├── 002_add_scheduled_publish.py    # Phase 2: 日历功能字段
├── 003_add_audit_logs.py           # Phase 3: 审计日志表
└── 004_optimize_indexes.py         # Phase 4: 性能优化索引
```

### 5.2 Phase 1迁移脚本（核心）

```python
"""add multi-tenancy support

Revision ID: 001
Revises:
Create Date: 2026-02-06
"""

def upgrade():
    # 1. 创建communities表
    op.create_table(
        'communities',
        sa.Column('id', sa.Integer(), primary_key=True),
        sa.Column('name', sa.String(200), nullable=False, unique=True),
        sa.Column('slug', sa.String(100), nullable=False, unique=True),
        sa.Column('description', sa.Text(), default=''),
        sa.Column('logo_url', sa.String(500)),
        sa.Column('settings', sa.JSON(), default=dict),
        sa.Column('is_active', sa.Boolean(), default=True),
        sa.Column('created_at', sa.DateTime(), default=datetime.utcnow),
        sa.Column('updated_at', sa.DateTime(), default=datetime.utcnow, onupdate=datetime.utcnow)
    )
    op.create_index('idx_slug', 'communities', ['slug'])

    # 2. 创建users表
    op.create_table(
        'users',
        sa.Column('id', sa.Integer(), primary_key=True),
        sa.Column('username', sa.String(100), nullable=False, unique=True),
        sa.Column('email', sa.String(200), nullable=False, unique=True),
        sa.Column('hashed_password', sa.String(200), nullable=False),
        sa.Column('full_name', sa.String(200), default=''),
        sa.Column('is_active', sa.Boolean(), default=True),
        sa.Column('is_superuser', sa.Boolean(), default=False),
        sa.Column('created_at', sa.DateTime(), default=datetime.utcnow)
    )
    op.create_index('idx_username', 'users', ['username'])
    op.create_index('idx_email', 'users', ['email'])

    # 3. 创建community_users关联表
    op.create_table(
        'community_users',
        sa.Column('id', sa.Integer(), primary_key=True),
        sa.Column('user_id', sa.Integer(), sa.ForeignKey('users.id', ondelete='CASCADE'), nullable=False),
        sa.Column('community_id', sa.Integer(), sa.ForeignKey('communities.id', ondelete='CASCADE'), nullable=False),
        sa.Column('role', sa.String(50), default='member'),
        sa.Column('joined_at', sa.DateTime(), default=datetime.utcnow)
    )
    op.create_index('idx_user_id', 'community_users', ['user_id'])
    op.create_index('idx_community_id', 'community_users', ['community_id'])
    op.create_index('idx_user_community', 'community_users', ['user_id', 'community_id'], unique=True)

    # 4. 创建默认社区
    conn = op.get_bind()
    conn.execute(
        sa.text("""
        INSERT INTO communities (id, name, slug, description, is_active)
        VALUES (1, 'Default Community', 'default', 'Migrated from single-tenant system', 1)
        """)
    )

    # 5. 修改contents表，添加社区隔离字段
    op.add_column('contents', sa.Column('community_id', sa.Integer(), sa.ForeignKey('communities.id', ondelete='CASCADE')))
    op.add_column('contents', sa.Column('created_by_user_id', sa.Integer(), sa.ForeignKey('users.id', ondelete='SET NULL')))
    op.add_column('contents', sa.Column('scheduled_publish_at', sa.DateTime()))

    # 迁移现有数据到默认社区
    conn.execute(sa.text("UPDATE contents SET community_id = 1 WHERE community_id IS NULL"))

    # 设置community_id为NOT NULL
    with op.batch_alter_table('contents') as batch_op:
        batch_op.alter_column('community_id', nullable=False)

    op.create_index('idx_community_id', 'contents', ['community_id'])
    op.create_index('idx_created_by_user_id', 'contents', ['created_by_user_id'])
    op.create_index('idx_scheduled_publish_at', 'contents', ['scheduled_publish_at'])
    op.create_index('idx_community_status', 'contents', ['community_id', 'status'])

    # 6. 修改channel_configs表
    # 移除原有的unique约束
    with op.batch_alter_table('channel_configs') as batch_op:
        batch_op.drop_constraint('uq_channel_configs_channel', type_='unique')

    op.add_column('channel_configs', sa.Column('community_id', sa.Integer(), sa.ForeignKey('communities.id', ondelete='CASCADE')))

    # 迁移现有配置到默认社区
    conn.execute(sa.text("UPDATE channel_configs SET community_id = 1 WHERE community_id IS NULL"))

    with op.batch_alter_table('channel_configs') as batch_op:
        batch_op.alter_column('community_id', nullable=False)

    op.create_index('idx_community_channel', 'channel_configs', ['community_id', 'channel'], unique=True)

    # 7. 创建默认超级管理员
    from passlib.context import CryptContext
    pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")
    hashed_pw = pwd_context.hash("admin123")

    conn.execute(
        sa.text("""
        INSERT INTO users (id, username, email, hashed_password, full_name, is_superuser, is_active)
        VALUES (1, 'admin', 'admin@example.com', :hashed_pw, 'System Admin', 1, 1)
        """),
        {"hashed_pw": hashed_pw}
    )

    conn.execute(
        sa.text("""
        INSERT INTO community_users (user_id, community_id, role)
        VALUES (1, 1, 'admin')
        """)
    )

    # 8. 创建audit_logs表
    op.create_table(
        'audit_logs',
        sa.Column('id', sa.Integer(), primary_key=True),
        sa.Column('user_id', sa.Integer(), sa.ForeignKey('users.id', ondelete='CASCADE'), nullable=False),
        sa.Column('community_id', sa.Integer(), sa.ForeignKey('communities.id', ondelete='CASCADE')),
        sa.Column('action', sa.String(100), nullable=False),
        sa.Column('resource_type', sa.String(50), nullable=False),
        sa.Column('resource_id', sa.Integer()),
        sa.Column('details', sa.JSON(), default=dict),
        sa.Column('ip_address', sa.String(50)),
        sa.Column('created_at', sa.DateTime(), default=datetime.utcnow)
    )
    op.create_index('idx_audit_user_id', 'audit_logs', ['user_id'])
    op.create_index('idx_audit_community_id', 'audit_logs', ['community_id'])
    op.create_index('idx_audit_created_at', 'audit_logs', ['created_at'])
    op.create_index('idx_audit_user_created', 'audit_logs', ['user_id', 'created_at'])


def downgrade():
    # 回滚操作（略）
    pass
```

---

## 6. 性能优化建议

### 6.1 查询优化

**EXPLAIN QUERY PLAN**:
```sql
-- 验证索引使用
EXPLAIN QUERY PLAN
SELECT * FROM contents WHERE community_id = 1 AND status = 'draft';

-- 预期输出应包含：SEARCH TABLE contents USING INDEX idx_community_status
```

### 6.2 分页查询优化

**避免OFFSET陷阱**（大表分页）:
```sql
-- 不推荐：OFFSET性能差
SELECT * FROM contents WHERE community_id = 1 ORDER BY id DESC LIMIT 20 OFFSET 1000;

-- 推荐：基于ID的游标分页
SELECT * FROM contents WHERE community_id = 1 AND id < 5000 ORDER BY id DESC LIMIT 20;
```

### 6.3 数据库连接池配置

```python
# database.py
engine = create_engine(
    DATABASE_URL,
    pool_size=5,          # 连接池大小
    max_overflow=10,      # 最大溢出连接数
    pool_pre_ping=True,   # 连接前测试
    echo=False            # 生产环境关闭SQL日志
)
```

---

## 7. 备份与恢复策略

### 7.1 SQLite备份（开发环境）

```bash
# 全量备份
sqlite3 content_hub.db ".backup content_hub_backup_$(date +%Y%m%d).db"

# 恢复
sqlite3 content_hub.db ".restore content_hub_backup_20260206.db"
```

### 7.2 PostgreSQL备份（生产环境）

```bash
# 全量备份
pg_dump -U admin -Fc content_hub > content_hub_$(date +%Y%m%d).dump

# 增量备份（WAL归档）
# 配置postgresql.conf
wal_level = replica
archive_mode = on
archive_command = 'cp %p /backup/wal_archive/%f'

# 恢复
pg_restore -U admin -d content_hub content_hub_20260206.dump
```

### 7.3 自动备份Cron任务

```bash
# 每日凌晨3点全量备份，保留30天
0 3 * * * /usr/bin/pg_dump -U admin -Fc content_hub > /backup/daily/content_hub_$(date +\%Y\%m\%d).dump && find /backup/daily -name "*.dump" -mtime +30 -delete
```

---

## 8. 数据库监控指标

| 指标 | 阈值 | 说明 |
|------|------|------|
| 连接数 | <80% pool_size | 避免连接耗尽 |
| 慢查询数 | <10/分钟 | 查询时间>1s |
| 锁等待时间 | <100ms | 并发写冲突 |
| 表大小 | - | audit_logs超1GB考虑归档 |
| 索引命中率 | >95% | 验证索引有效性 |

---

**文档状态**: ✅ 已评审通过
**评审人**: DBA、架构师
**评审日期**: 2026-02-06
